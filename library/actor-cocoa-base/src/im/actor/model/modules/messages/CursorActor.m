//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/modules/messages/CursorActor.java
//


#line 1 "/Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/modules/messages/CursorActor.java"

#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "im/actor/model/droidkit/actors/Actor.h"
#include "im/actor/model/droidkit/actors/ActorRef.h"
#include "im/actor/model/droidkit/engine/SyncKeyValue.h"
#include "im/actor/model/entity/Peer.h"
#include "im/actor/model/modules/Messages.h"
#include "im/actor/model/modules/Modules.h"
#include "im/actor/model/modules/messages/CursorActor.h"
#include "im/actor/model/modules/messages/entity/PlainCursor.h"
#include "im/actor/model/modules/messages/entity/PlainCursorsStorage.h"
#include "im/actor/model/modules/utils/ModuleActor.h"
#include "java/io/IOException.h"
#include "java/lang/Math.h"
#include "java/util/Collection.h"
#include "java/util/HashSet.h"

#pragma clang diagnostic ignored "-Wprotocol"
#pragma clang diagnostic ignored "-Wincomplete-implementation"

@interface ImActorModelModulesMessagesCursorActor () {
 @public
  ImActorModelModulesMessagesEntityPlainCursorsStorage *plainCursorsStorage_;
  JavaUtilHashSet *inProgress_;
  jlong cursorId_;
  DKSyncKeyValue *keyValue_;
}

- (void)saveCursorState;

@end

J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesCursorActor, plainCursorsStorage_, ImActorModelModulesMessagesEntityPlainCursorsStorage *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesCursorActor, inProgress_, JavaUtilHashSet *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesCursorActor, keyValue_, DKSyncKeyValue *)

__attribute__((unused)) static void ImActorModelModulesMessagesCursorActor_onMovedWithAMPeer_withLong_(ImActorModelModulesMessagesCursorActor *self, AMPeer *peer, jlong date);

__attribute__((unused)) static void ImActorModelModulesMessagesCursorActor_saveCursorState(ImActorModelModulesMessagesCursorActor *self);

@interface ImActorModelModulesMessagesCursorActor_OnCompleted : NSObject {
 @public
  AMPeer *peer_;
  jlong date_;
}

- (instancetype)initWithAMPeer:(AMPeer *)peer
                      withLong:(jlong)date;

- (AMPeer *)getPeer;

- (jlong)getDate;

@end

J2OBJC_EMPTY_STATIC_INIT(ImActorModelModulesMessagesCursorActor_OnCompleted)

J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesCursorActor_OnCompleted, peer_, AMPeer *)

__attribute__((unused)) static void ImActorModelModulesMessagesCursorActor_OnCompleted_initWithAMPeer_withLong_(ImActorModelModulesMessagesCursorActor_OnCompleted *self, AMPeer *peer, jlong date);

__attribute__((unused)) static ImActorModelModulesMessagesCursorActor_OnCompleted *new_ImActorModelModulesMessagesCursorActor_OnCompleted_initWithAMPeer_withLong_(AMPeer *peer, jlong date) NS_RETURNS_RETAINED;

J2OBJC_TYPE_LITERAL_HEADER(ImActorModelModulesMessagesCursorActor_OnCompleted)


#line 16
@implementation ImActorModelModulesMessagesCursorActor


#line 23
- (instancetype)initWithLong:(jlong)cursorId
withImActorModelModulesModules:(ImActorModelModulesModules *)messenger {
  ImActorModelModulesMessagesCursorActor_initWithLong_withImActorModelModulesModules_(self, cursorId, messenger);
  return self;
}


#line 30
- (void)preStart {
  [super preStart];
  
#line 33
  plainCursorsStorage_ = new_ImActorModelModulesMessagesEntityPlainCursorsStorage_init();
  IOSByteArray *data = [((DKSyncKeyValue *) nil_chk(keyValue_)) getWithLong:cursorId_];
  if (data != nil) {
    @try {
      plainCursorsStorage_ = ImActorModelModulesMessagesEntityPlainCursorsStorage_fromBytesWithByteArray_(data);
    }
    @catch (
#line 38
    JavaIoIOException *e) {
      [((JavaIoIOException *) nil_chk(e)) printStackTrace];
    }
  }
  
#line 43
  for (ImActorModelModulesMessagesEntityPlainCursor * __strong cursor in nil_chk([((ImActorModelModulesMessagesEntityPlainCursorsStorage *) nil_chk(plainCursorsStorage_)) getAllCursors])) {
    if ([((ImActorModelModulesMessagesEntityPlainCursor *) nil_chk(cursor)) getSortDate] < [cursor getPendingSortDate]) {
      [((JavaUtilHashSet *) nil_chk(inProgress_)) addWithId:[cursor getPeer]];
      [self performWithAMPeer:[cursor getPeer] withLong:[cursor getPendingSortDate]];
    }
  }
}


#line 51
- (void)moveCursorWithAMPeer:(AMPeer *)peer
                    withLong:(jlong)date {
  ImActorModelModulesMessagesEntityPlainCursor *cursor = [((ImActorModelModulesMessagesEntityPlainCursorsStorage *) nil_chk(plainCursorsStorage_)) getCursorWithAMPeer:peer];
  if (date <= [((ImActorModelModulesMessagesEntityPlainCursor *) nil_chk(cursor)) getSortDate]) {
    return;
  }
  if (date <= [cursor getPendingSortDate]) {
    return;
  }
  
#line 60
  date = JavaLangMath_maxWithLong_withLong_([cursor getPendingSortDate], date);
  
#line 62
  [plainCursorsStorage_ putCursorWithImActorModelModulesMessagesEntityPlainCursor:[cursor changePendingSortDateWithLong:date]];
  
#line 64
  ImActorModelModulesMessagesCursorActor_saveCursorState(self);
  
#line 66
  if ([((JavaUtilHashSet *) nil_chk(inProgress_)) containsWithId:peer]) {
    return;
  }
  
#line 70
  [inProgress_ addWithId:peer];
  [self performWithAMPeer:peer withLong:date];
}


#line 74
- (void)onMovedWithAMPeer:(AMPeer *)peer
                 withLong:(jlong)date {
  ImActorModelModulesMessagesCursorActor_onMovedWithAMPeer_withLong_(self, peer, date);
}


#line 91
- (void)onCompletedWithAMPeer:(AMPeer *)peer
                     withLong:(jlong)date {
  [((DKActorRef *) nil_chk([self self__])) sendWithId:new_ImActorModelModulesMessagesCursorActor_OnCompleted_initWithAMPeer_withLong_(peer, date)];
}


#line 95
- (void)onErrorWithAMPeer:(AMPeer *)peer
                 withLong:(jlong)date {
}


#line 100
- (void)saveCursorState {
  ImActorModelModulesMessagesCursorActor_saveCursorState(self);
}


#line 105
- (void)onReceiveWithId:(id)message {
  if ([message isKindOfClass:[ImActorModelModulesMessagesCursorActor_OnCompleted class]]) {
    ImActorModelModulesMessagesCursorActor_OnCompleted *completed = (ImActorModelModulesMessagesCursorActor_OnCompleted *) check_class_cast(message, [ImActorModelModulesMessagesCursorActor_OnCompleted class]);
    ImActorModelModulesMessagesCursorActor_onMovedWithAMPeer_withLong_(self, [((ImActorModelModulesMessagesCursorActor_OnCompleted *) nil_chk(completed)) getPeer], [completed getDate]);
  }
  else {
    
#line 110
    [self dropWithId:message];
  }
}

@end


#line 23
void ImActorModelModulesMessagesCursorActor_initWithLong_withImActorModelModulesModules_(ImActorModelModulesMessagesCursorActor *self, jlong cursorId, ImActorModelModulesModules *messenger) {
  (void) ImActorModelModulesUtilsModuleActor_initWithImActorModelModulesModules_(self, messenger);
  self->inProgress_ = new_JavaUtilHashSet_init();
  
#line 25
  self->cursorId_ = cursorId;
  self->keyValue_ = [((ImActorModelModulesMessages *) nil_chk([((ImActorModelModulesModules *) nil_chk(messenger)) getMessagesModule])) getCursorStorage];
}


#line 74
void ImActorModelModulesMessagesCursorActor_onMovedWithAMPeer_withLong_(ImActorModelModulesMessagesCursorActor *self, AMPeer *peer, jlong date) {
  [((JavaUtilHashSet *) nil_chk(self->inProgress_)) removeWithId:peer];
  
#line 77
  ImActorModelModulesMessagesEntityPlainCursor *cursor = [((ImActorModelModulesMessagesEntityPlainCursorsStorage *) nil_chk(self->plainCursorsStorage_)) getCursorWithAMPeer:peer];
  cursor = [cursor changeSortDateWithLong:JavaLangMath_maxWithLong_withLong_(date, [((ImActorModelModulesMessagesEntityPlainCursor *) nil_chk(cursor)) getSortDate])];
  [self->plainCursorsStorage_ putCursorWithImActorModelModulesMessagesEntityPlainCursor:cursor];
  ImActorModelModulesMessagesCursorActor_saveCursorState(self);
  
#line 82
  if ([((ImActorModelModulesMessagesEntityPlainCursor *) nil_chk(cursor)) getSortDate] < [cursor getPendingSortDate]) {
    [self->inProgress_ addWithId:peer];
    [self performWithAMPeer:peer withLong:[cursor getPendingSortDate]];
  }
}


#line 100
void ImActorModelModulesMessagesCursorActor_saveCursorState(ImActorModelModulesMessagesCursorActor *self) {
  [((DKSyncKeyValue *) nil_chk(self->keyValue_)) putWithLong:self->cursorId_ withByteArray:[((ImActorModelModulesMessagesEntityPlainCursorsStorage *) nil_chk(self->plainCursorsStorage_)) toByteArray]];
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesCursorActor)


#line 114
@implementation ImActorModelModulesMessagesCursorActor_OnCompleted


#line 118
- (instancetype)initWithAMPeer:(AMPeer *)peer
                      withLong:(jlong)date {
  ImActorModelModulesMessagesCursorActor_OnCompleted_initWithAMPeer_withLong_(self, peer, date);
  return self;
}


#line 123
- (AMPeer *)getPeer {
  return peer_;
}

- (jlong)getDate {
  return date_;
}

@end


#line 118
void ImActorModelModulesMessagesCursorActor_OnCompleted_initWithAMPeer_withLong_(ImActorModelModulesMessagesCursorActor_OnCompleted *self, AMPeer *peer, jlong date) {
  (void) NSObject_init(self);
  
#line 119
  self->peer_ = peer;
  self->date_ = date;
}


#line 118
ImActorModelModulesMessagesCursorActor_OnCompleted *new_ImActorModelModulesMessagesCursorActor_OnCompleted_initWithAMPeer_withLong_(AMPeer *peer, jlong date) {
  ImActorModelModulesMessagesCursorActor_OnCompleted *self = [ImActorModelModulesMessagesCursorActor_OnCompleted alloc];
  ImActorModelModulesMessagesCursorActor_OnCompleted_initWithAMPeer_withLong_(self, peer, date);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesCursorActor_OnCompleted)
