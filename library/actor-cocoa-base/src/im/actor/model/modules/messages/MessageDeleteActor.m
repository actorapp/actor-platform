//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/modules/messages/MessageDeleteActor.java
//


#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "im/actor/model/api/OutPeer.h"
#include "im/actor/model/api/Peer.h"
#include "im/actor/model/api/base/SeqUpdate.h"
#include "im/actor/model/api/rpc/RequestDeleteMessage.h"
#include "im/actor/model/api/rpc/ResponseSeq.h"
#include "im/actor/model/api/updates/UpdateMessageDelete.h"
#include "im/actor/model/droidkit/actors/Actor.h"
#include "im/actor/model/droidkit/engine/SyncKeyValue.h"
#include "im/actor/model/entity/Peer.h"
#include "im/actor/model/modules/Messages.h"
#include "im/actor/model/modules/Modules.h"
#include "im/actor/model/modules/Updates.h"
#include "im/actor/model/modules/messages/MessageDeleteActor.h"
#include "im/actor/model/modules/messages/entity/Delete.h"
#include "im/actor/model/modules/messages/entity/DeleteStorage.h"
#include "im/actor/model/modules/utils/ModuleActor.h"
#include "im/actor/model/network/RpcCallback.h"
#include "im/actor/model/network/RpcException.h"
#include "java/io/IOException.h"
#include "java/lang/Long.h"
#include "java/util/ArrayList.h"
#include "java/util/HashMap.h"
#include "java/util/List.h"
#include "java/util/Set.h"

@interface ImActorModelModulesMessagesMessageDeleteActor () {
 @public
  DKSyncKeyValue *syncKeyValue_;
  ImActorModelModulesMessagesEntityDeleteStorage *deleteStorage_;
}

@end

J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor, syncKeyValue_, DKSyncKeyValue *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor, deleteStorage_, ImActorModelModulesMessagesEntityDeleteStorage *)

@interface ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage () {
 @public
  AMPeer *peer_;
  IOSLongArray *rids_;
}

@end

J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage, peer_, AMPeer *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage, rids_, IOSLongArray *)

@interface ImActorModelModulesMessagesMessageDeleteActor_$1 : NSObject < AMRpcCallback > {
 @public
  ImActorModelModulesMessagesMessageDeleteActor *this$0_;
  AMPeer *val$peer_;
  id<JavaUtilList> val$rids_;
  APPeer *val$apiPeer_;
}

- (void)onResult:(APResponseSeq *)response;

- (void)onError:(AMRpcException *)e;

- (instancetype)initWithImActorModelModulesMessagesMessageDeleteActor:(ImActorModelModulesMessagesMessageDeleteActor *)outer$
                                                           withAMPeer:(AMPeer *)capture$0
                                                     withJavaUtilList:(id<JavaUtilList>)capture$1
                                                           withAPPeer:(APPeer *)capture$2;

@end

J2OBJC_EMPTY_STATIC_INIT(ImActorModelModulesMessagesMessageDeleteActor_$1)

J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor_$1, this$0_, ImActorModelModulesMessagesMessageDeleteActor *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor_$1, val$peer_, AMPeer *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor_$1, val$rids_, id<JavaUtilList>)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor_$1, val$apiPeer_, APPeer *)

__attribute__((unused)) static void ImActorModelModulesMessagesMessageDeleteActor_$1_initWithImActorModelModulesMessagesMessageDeleteActor_withAMPeer_withJavaUtilList_withAPPeer_(ImActorModelModulesMessagesMessageDeleteActor_$1 *self, ImActorModelModulesMessagesMessageDeleteActor *outer$, AMPeer *capture$0, id<JavaUtilList> capture$1, APPeer *capture$2);

__attribute__((unused)) static ImActorModelModulesMessagesMessageDeleteActor_$1 *new_ImActorModelModulesMessagesMessageDeleteActor_$1_initWithImActorModelModulesMessagesMessageDeleteActor_withAMPeer_withJavaUtilList_withAPPeer_(ImActorModelModulesMessagesMessageDeleteActor *outer$, AMPeer *capture$0, id<JavaUtilList> capture$1, APPeer *capture$2) NS_RETURNS_RETAINED;

J2OBJC_TYPE_LITERAL_HEADER(ImActorModelModulesMessagesMessageDeleteActor_$1)

@implementation ImActorModelModulesMessagesMessageDeleteActor

- (instancetype)initWithImActorModelModulesModules:(ImActorModelModulesModules *)modules {
  ImActorModelModulesMessagesMessageDeleteActor_initWithImActorModelModulesModules_(self, modules);
  return self;
}

- (void)preStart {
  [super preStart];
  IOSByteArray *data = [((DKSyncKeyValue *) nil_chk(syncKeyValue_)) getWithLong:ImActorModelModulesUtilsModuleActor_CURSOR_DELETE];
  if (data != nil) {
    @try {
      deleteStorage_ = ImActorModelModulesMessagesEntityDeleteStorage_fromBytesWithByteArray_(data);
    }
    @catch (JavaIoIOException *e) {
      [((JavaIoIOException *) nil_chk(e)) printStackTrace];
      deleteStorage_ = new_ImActorModelModulesMessagesEntityDeleteStorage_init();
    }
  }
  else {
    deleteStorage_ = new_ImActorModelModulesMessagesEntityDeleteStorage_init();
  }
  for (AMPeer * __strong peer in nil_chk([((JavaUtilHashMap *) nil_chk([((ImActorModelModulesMessagesEntityDeleteStorage *) nil_chk(deleteStorage_)) getPendingDeletions])) keySet])) {
    ImActorModelModulesMessagesEntityDelete *delete_ = [((JavaUtilHashMap *) nil_chk([deleteStorage_ getPendingDeletions])) getWithId:peer];
    if ([((id<JavaUtilList>) nil_chk([((ImActorModelModulesMessagesEntityDelete *) nil_chk(delete_)) getRids])) size] > 0) {
      [self performDeleteWithAMPeer:peer withJavaUtilList:[delete_ getRids]];
    }
  }
}

- (void)saveStorage {
  [((DKSyncKeyValue *) nil_chk(syncKeyValue_)) putWithLong:ImActorModelModulesUtilsModuleActor_CURSOR_DELETE withByteArray:[((ImActorModelModulesMessagesEntityDeleteStorage *) nil_chk(deleteStorage_)) toByteArray]];
}

- (void)performDeleteWithAMPeer:(AMPeer *)peer
               withJavaUtilList:(id<JavaUtilList>)rids {
  APOutPeer *outPeer = [self buidOutPeerWithAMPeer:peer];
  APPeer *apiPeer = [self buildApiPeerWithAMPeer:peer];
  [self requestWithAPRequest:new_APRequestDeleteMessage_initWithAPOutPeer_withJavaUtilList_(outPeer, rids) withAMRpcCallback:new_ImActorModelModulesMessagesMessageDeleteActor_$1_initWithImActorModelModulesMessagesMessageDeleteActor_withAMPeer_withJavaUtilList_withAPPeer_(self, peer, rids, apiPeer)];
}

- (void)onDeleteMessageWithAMPeer:(AMPeer *)peer
                 withJavaUtilList:(id<JavaUtilList>)rids {
  if (![((JavaUtilHashMap *) nil_chk([((ImActorModelModulesMessagesEntityDeleteStorage *) nil_chk(deleteStorage_)) getPendingDeletions])) containsKeyWithId:peer]) {
    (void) [((JavaUtilHashMap *) nil_chk([deleteStorage_ getPendingDeletions])) putWithId:peer withId:new_ImActorModelModulesMessagesEntityDelete_initWithAMPeer_withJavaUtilList_(peer, new_JavaUtilArrayList_init())];
  }
  [((id<JavaUtilList>) nil_chk([((ImActorModelModulesMessagesEntityDelete *) nil_chk([((JavaUtilHashMap *) nil_chk([deleteStorage_ getPendingDeletions])) getWithId:peer])) getRids])) addAllWithJavaUtilCollection:rids];
  [self saveStorage];
  [self performDeleteWithAMPeer:peer withJavaUtilList:rids];
}

- (void)onReceiveWithId:(id)message {
  if ([message isKindOfClass:[ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage class]]) {
    ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage *deleteMessage = (ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage *) check_class_cast(message, [ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage class]);
    JavaUtilArrayList *rids = new_JavaUtilArrayList_init();
    {
      IOSLongArray *a__ = [((ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage *) nil_chk(deleteMessage)) getRids];
      jlong const *b__ = ((IOSLongArray *) nil_chk(a__))->buffer_;
      jlong const *e__ = b__ + a__->size_;
      while (b__ < e__) {
        jlong l = *b__++;
        [rids addWithId:JavaLangLong_valueOfWithLong_(l)];
      }
    }
    [self onDeleteMessageWithAMPeer:[deleteMessage getPeer] withJavaUtilList:rids];
  }
  else {
    [self dropWithId:message];
  }
}

@end

void ImActorModelModulesMessagesMessageDeleteActor_initWithImActorModelModulesModules_(ImActorModelModulesMessagesMessageDeleteActor *self, ImActorModelModulesModules *modules) {
  (void) ImActorModelModulesUtilsModuleActor_initWithImActorModelModulesModules_(self, modules);
  self->syncKeyValue_ = [((ImActorModelModulesMessages *) nil_chk([((ImActorModelModulesModules *) nil_chk(modules)) getMessagesModule])) getCursorStorage];
}

ImActorModelModulesMessagesMessageDeleteActor *new_ImActorModelModulesMessagesMessageDeleteActor_initWithImActorModelModulesModules_(ImActorModelModulesModules *modules) {
  ImActorModelModulesMessagesMessageDeleteActor *self = [ImActorModelModulesMessagesMessageDeleteActor alloc];
  ImActorModelModulesMessagesMessageDeleteActor_initWithImActorModelModulesModules_(self, modules);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesMessageDeleteActor)

@implementation ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage

- (instancetype)initWithAMPeer:(AMPeer *)peer
                 withLongArray:(IOSLongArray *)rids {
  ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage_initWithAMPeer_withLongArray_(self, peer, rids);
  return self;
}

- (AMPeer *)getPeer {
  return peer_;
}

- (IOSLongArray *)getRids {
  return rids_;
}

@end

void ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage_initWithAMPeer_withLongArray_(ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage *self, AMPeer *peer, IOSLongArray *rids) {
  (void) NSObject_init(self);
  self->peer_ = peer;
  self->rids_ = rids;
}

ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage *new_ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage_initWithAMPeer_withLongArray_(AMPeer *peer, IOSLongArray *rids) {
  ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage *self = [ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage alloc];
  ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage_initWithAMPeer_withLongArray_(self, peer, rids);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage)

@implementation ImActorModelModulesMessagesMessageDeleteActor_$1

- (void)onResult:(APResponseSeq *)response {
  if ([((JavaUtilHashMap *) nil_chk([((ImActorModelModulesMessagesEntityDeleteStorage *) nil_chk(this$0_->deleteStorage_)) getPendingDeletions])) containsKeyWithId:val$peer_]) {
    [((id<JavaUtilList>) nil_chk([((ImActorModelModulesMessagesEntityDelete *) nil_chk([((JavaUtilHashMap *) nil_chk([this$0_->deleteStorage_ getPendingDeletions])) getWithId:val$peer_])) getRids])) removeAllWithJavaUtilCollection:val$rids_];
    [this$0_ saveStorage];
  }
  [((ImActorModelModulesUpdates *) nil_chk([this$0_ updates])) onUpdateReceivedWithId:new_ImActorModelApiBaseSeqUpdate_initWithInt_withByteArray_withInt_withByteArray_([((APResponseSeq *) nil_chk(response)) getSeq], [response getState], APUpdateMessageDelete_HEADER, [new_APUpdateMessageDelete_initWithAPPeer_withJavaUtilList_(val$apiPeer_, val$rids_) toByteArray])];
}

- (void)onError:(AMRpcException *)e {
}

- (instancetype)initWithImActorModelModulesMessagesMessageDeleteActor:(ImActorModelModulesMessagesMessageDeleteActor *)outer$
                                                           withAMPeer:(AMPeer *)capture$0
                                                     withJavaUtilList:(id<JavaUtilList>)capture$1
                                                           withAPPeer:(APPeer *)capture$2 {
  ImActorModelModulesMessagesMessageDeleteActor_$1_initWithImActorModelModulesMessagesMessageDeleteActor_withAMPeer_withJavaUtilList_withAPPeer_(self, outer$, capture$0, capture$1, capture$2);
  return self;
}

@end

void ImActorModelModulesMessagesMessageDeleteActor_$1_initWithImActorModelModulesMessagesMessageDeleteActor_withAMPeer_withJavaUtilList_withAPPeer_(ImActorModelModulesMessagesMessageDeleteActor_$1 *self, ImActorModelModulesMessagesMessageDeleteActor *outer$, AMPeer *capture$0, id<JavaUtilList> capture$1, APPeer *capture$2) {
  self->this$0_ = outer$;
  self->val$peer_ = capture$0;
  self->val$rids_ = capture$1;
  self->val$apiPeer_ = capture$2;
  (void) NSObject_init(self);
}

ImActorModelModulesMessagesMessageDeleteActor_$1 *new_ImActorModelModulesMessagesMessageDeleteActor_$1_initWithImActorModelModulesMessagesMessageDeleteActor_withAMPeer_withJavaUtilList_withAPPeer_(ImActorModelModulesMessagesMessageDeleteActor *outer$, AMPeer *capture$0, id<JavaUtilList> capture$1, APPeer *capture$2) {
  ImActorModelModulesMessagesMessageDeleteActor_$1 *self = [ImActorModelModulesMessagesMessageDeleteActor_$1 alloc];
  ImActorModelModulesMessagesMessageDeleteActor_$1_initWithImActorModelModulesMessagesMessageDeleteActor_withAMPeer_withJavaUtilList_withAPPeer_(self, outer$, capture$0, capture$1, capture$2);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesMessageDeleteActor_$1)
