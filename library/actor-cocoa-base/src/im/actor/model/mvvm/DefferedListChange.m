//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/mvvm/DefferedListChange.java
//


#include "J2ObjC_source.h"
#include "im/actor/model/mvvm/DefferedListChange.h"
#include "im/actor/model/mvvm/DefferedListModification.h"
#include "im/actor/model/mvvm/DisplayList.h"
#include "java/lang/RuntimeException.h"
#include "java/util/ArrayList.h"
#include "java/util/HashMap.h"
#include "java/util/HashSet.h"

@interface AMDefferedListChange () {
 @public
  JavaUtilArrayList *list_;
  JavaUtilArrayList *modifications_;
}

@end

J2OBJC_FIELD_SETTER(AMDefferedListChange, list_, JavaUtilArrayList *)
J2OBJC_FIELD_SETTER(AMDefferedListChange, modifications_, JavaUtilArrayList *)

@implementation AMDefferedListChange

- (instancetype)initWithJavaUtilArrayList:(JavaUtilArrayList *)list
                    withJavaUtilArrayList:(JavaUtilArrayList *)modifications {
  AMDefferedListChange_initWithJavaUtilArrayList_withJavaUtilArrayList_(self, list, modifications);
  return self;
}

- (id)getItemWithInt:(jint)index {
  return [((JavaUtilArrayList *) nil_chk(list_)) getWithInt:index];
}

- (jint)getCount {
  return [((JavaUtilArrayList *) nil_chk(list_)) size];
}

- (AMDefferedListModification *)next {
  if ([((JavaUtilArrayList *) nil_chk(modifications_)) size] == 0) {
    return nil;
  }
  AMDefferedListModification *modification = [modifications_ removeWithInt:0];
  {
    jint addIndex;
    jint removeIndex;
    id removed;
    switch ([[((AMDefferedListModification *) nil_chk(modification)) getOperation] ordinal]) {
      case AMDefferedListModification_Operation_ADD:
      case AMDefferedListModification_Operation_ADD_RANGE:
      addIndex = [modification getIndex];
      for (id __strong itm in nil_chk([modification getItems])) {
        [((JavaUtilArrayList *) nil_chk(list_)) addWithInt:addIndex++ withId:itm];
      }
      break;
      case AMDefferedListModification_Operation_REMOVE:
      (void) [((JavaUtilArrayList *) nil_chk(list_)) removeWithInt:[modification getIndex]];
      break;
      case AMDefferedListModification_Operation_REMOVE_RANGE:
      removeIndex = [modification getIndex];
      for (jint i = 0; i < [modification getLength]; i++) {
        (void) [((JavaUtilArrayList *) nil_chk(list_)) removeWithInt:removeIndex];
      }
      break;
      case AMDefferedListModification_Operation_MOVE:
      removed = [((JavaUtilArrayList *) nil_chk(list_)) removeWithInt:[modification getIndex]];
      [list_ addWithInt:[modification getDestIndex] withId:removed];
      break;
      case AMDefferedListModification_Operation_UPDATE_RANGE:
      case AMDefferedListModification_Operation_UPDATE:
      break;
    }
  }
  return modification;
}

+ (AMDefferedListChange *)buildAndroidListChangeWithJavaUtilArrayList:(JavaUtilArrayList *)modificationResults
                                                withJavaUtilArrayList:(JavaUtilArrayList *)initialList {
  return AMDefferedListChange_buildAndroidListChangeWithJavaUtilArrayList_withJavaUtilArrayList_(modificationResults, initialList);
}

@end

void AMDefferedListChange_initWithJavaUtilArrayList_withJavaUtilArrayList_(AMDefferedListChange *self, JavaUtilArrayList *list, JavaUtilArrayList *modifications) {
  (void) NSObject_init(self);
  self->list_ = list;
  self->modifications_ = modifications;
}

AMDefferedListChange *new_AMDefferedListChange_initWithJavaUtilArrayList_withJavaUtilArrayList_(JavaUtilArrayList *list, JavaUtilArrayList *modifications) {
  AMDefferedListChange *self = [AMDefferedListChange alloc];
  AMDefferedListChange_initWithJavaUtilArrayList_withJavaUtilArrayList_(self, list, modifications);
  return self;
}

AMDefferedListChange *AMDefferedListChange_buildAndroidListChangeWithJavaUtilArrayList_withJavaUtilArrayList_(JavaUtilArrayList *modificationResults, JavaUtilArrayList *initialList) {
  AMDefferedListChange_initialize();
  JavaUtilArrayList *listModifications = new_JavaUtilArrayList_init();
  AMDefferedListModification *prev = nil;
  for (AMDisplayList_ModificationResult * __strong res in nil_chk(modificationResults)) {
    for (AMDisplayList_ModificationResult_Operation * __strong operation in nil_chk([((AMDisplayList_ModificationResult *) nil_chk(res)) getOperations])) {
      AMDefferedListModification *mod = nil;
      switch ([[((AMDisplayList_ModificationResult_Operation *) nil_chk(operation)) getType] ordinal]) {
        case AMDisplayList_ModificationResult_OperationType_ADD:
        if (prev != nil) {
          if ([prev getOperation] == AMDefferedListModification_OperationEnum_get_ADD()) {
            if ([prev getIndex] == [operation getIndex] - 1) {
              [prev expandWithId:[operation getItem]];
              continue;
            }
          }
          else if ([prev getOperation] == AMDefferedListModification_OperationEnum_get_ADD_RANGE()) {
            if ([prev getIndex] + [prev getLength] == [operation getIndex]) {
              [prev expandWithId:[operation getItem]];
              continue;
            }
          }
        }
        mod = new_AMDefferedListModification_initWithAMDefferedListModification_OperationEnum_withInt_withId_(AMDefferedListModification_OperationEnum_get_ADD(), [operation getIndex], [operation getItem]);
        break;
        case AMDisplayList_ModificationResult_OperationType_UPDATE:
        if (prev != nil) {
          if ([prev getOperation] == AMDefferedListModification_OperationEnum_get_UPDATE()) {
            if ([prev getIndex] == [operation getIndex] - 1) {
              [prev expandWithId:[operation getItem]];
              continue;
            }
          }
          else if ([prev getOperation] == AMDefferedListModification_OperationEnum_get_UPDATE_RANGE()) {
            if ([prev getIndex] + [prev getLength] == [operation getIndex]) {
              [prev expandWithId:[operation getItem]];
              continue;
            }
          }
        }
        mod = new_AMDefferedListModification_initWithAMDefferedListModification_OperationEnum_withInt_withId_(AMDefferedListModification_OperationEnum_get_UPDATE(), [operation getIndex], [operation getItem]);
        break;
        case AMDisplayList_ModificationResult_OperationType_REMOVE:
        if (prev != nil) {
          if ([prev getOperation] == AMDefferedListModification_OperationEnum_get_REMOVE()) {
            if ([prev getIndex] == [operation getIndex] - 1) {
              [prev expandWithId:[operation getItem]];
              continue;
            }
          }
          else if ([prev getOperation] == AMDefferedListModification_OperationEnum_get_REMOVE_RANGE()) {
            if ([prev getIndex] + [prev getLength] == [operation getIndex]) {
              [prev expandWithId:[operation getItem]];
              continue;
            }
          }
        }
        mod = new_AMDefferedListModification_initWithAMDefferedListModification_OperationEnum_withInt_(AMDefferedListModification_OperationEnum_get_REMOVE(), [operation getIndex]);
        break;
        case AMDisplayList_ModificationResult_OperationType_MOVE:
        mod = new_AMDefferedListModification_initWithAMDefferedListModification_OperationEnum_withInt_withInt_withInt_(AMDefferedListModification_OperationEnum_get_MOVE(), [operation getIndex], [operation getDestIndex], 1);
        break;
      }
      if (mod != nil) {
        prev = mod;
        [listModifications addWithId:mod];
      }
    }
  }
  JavaUtilArrayList *optimizedModifications = new_JavaUtilArrayList_init();
  JavaUtilArrayList *tempList = new_JavaUtilArrayList_initWithJavaUtilCollection_(initialList);
  JavaUtilHashSet *removed = new_JavaUtilHashSet_init();
  for (AMDefferedListModification * __strong m in listModifications) {
    if ([((AMDefferedListModification *) nil_chk(m)) getOperation] == AMDefferedListModification_OperationEnum_get_REMOVE() || [m getOperation] == AMDefferedListModification_OperationEnum_get_REMOVE_RANGE()) {
      jint removeIndex = [m getIndex];
      for (jint i = 0; i < [m getLength]; i++) {
        id toRemove = [tempList removeWithInt:removeIndex];
        [removed removeWithId:toRemove];
        for (jint j = 0; j < [((JavaUtilArrayList *) nil_chk(initialList)) size]; j++) {
          if ([initialList getWithInt:j] == toRemove) {
            [optimizedModifications addWithId:new_AMDefferedListModification_initWithAMDefferedListModification_OperationEnum_withInt_(AMDefferedListModification_OperationEnum_get_REMOVE(), j)];
            break;
          }
        }
      }
    }
    else {
      {
        id itm;
        jint index;
        switch ([[m getOperation] ordinal]) {
          case AMDefferedListModification_Operation_MOVE:
          itm = [tempList removeWithInt:[m getIndex]];
          [tempList addWithInt:[m getDestIndex] withId:itm];
          break;
          case AMDefferedListModification_Operation_ADD:
          case AMDefferedListModification_Operation_ADD_RANGE:
          index = [m getIndex];
          for (id __strong i in nil_chk([m getItems])) {
            [tempList addWithInt:index++ withId:i];
          }
          break;
          default:
          case AMDefferedListModification_Operation_UPDATE_RANGE:
          case AMDefferedListModification_Operation_UPDATE:
          break;
        }
      }
    }
  }
  tempList = new_JavaUtilArrayList_initWithJavaUtilCollection_(initialList);
  for (AMDefferedListModification * __strong m in optimizedModifications) {
    jint index = [((AMDefferedListModification *) nil_chk(m)) getIndex];
    for (jint i = 0; i < index; i++) {
      (void) [tempList removeWithInt:i];
    }
  }
  JavaUtilHashMap *updated = new_JavaUtilHashMap_init();
  for (AMDefferedListModification * __strong m in listModifications) {
    {
      if ([((AMDefferedListModification *) nil_chk(m)) getOperation] == AMDefferedListModification_OperationEnum_get_REMOVE() || [m getOperation] == AMDefferedListModification_OperationEnum_get_REMOVE_RANGE()) {
        continue;
      }
      if ([m getOperation] == AMDefferedListModification_OperationEnum_get_UPDATE() || [m getOperation] == AMDefferedListModification_OperationEnum_get_UPDATE_RANGE()) {
        jint updateIndex = [m getIndex];
        for (jint i = 0; i < [m getLength]; i++) {
          id newElement = [((JavaUtilArrayList *) nil_chk([m getItems])) getWithInt:i];
          id oldElement = [tempList removeWithInt:updateIndex];
          [tempList addWithInt:updateIndex withId:oldElement];
          updateIndex++;
          if ([updated containsKeyWithId:oldElement]) {
            AMDefferedListModification *oldMod = [updated removeWithId:oldElement];
            [((AMDefferedListModification *) nil_chk(oldMod)) replaceWithId:newElement];
            (void) [updated putWithId:newElement withId:oldMod];
          }
          else {
            for (jint j = 0; j < [((JavaUtilArrayList *) nil_chk(initialList)) size]; j++) {
              if ([initialList getWithInt:j] == oldElement) {
                AMDefferedListModification *mod = new_AMDefferedListModification_initWithAMDefferedListModification_OperationEnum_withInt_withId_(AMDefferedListModification_OperationEnum_get_UPDATE(), j, newElement);
                (void) [updated putWithId:newElement withId:mod];
                [optimizedModifications addWithId:mod];
                goto continue_outer;
              }
            }
            @throw new_JavaLangRuntimeException_initWithNSString_(@"Unknown state");
          }
        }
      }
      {
        id itm;
        switch ([[m getOperation] ordinal]) {
          case AMDefferedListModification_Operation_MOVE:
          itm = [tempList removeWithInt:[m getIndex]];
          [tempList addWithInt:[m getDestIndex] withId:itm];
          break;
          default:
          break;
        }
      }
    }
    continue_outer: ;
  }
  tempList = new_JavaUtilArrayList_initWithJavaUtilCollection_(initialList);
  for (AMDefferedListModification * __strong m in optimizedModifications) {
    if ([((AMDefferedListModification *) nil_chk(m)) getOperation] == AMDefferedListModification_OperationEnum_get_REMOVE() || [m getOperation] == AMDefferedListModification_OperationEnum_get_REMOVE_RANGE()) {
      jint index = [m getIndex];
      for (jint i = 0; i < index; i++) {
        (void) [tempList removeWithInt:i];
      }
    }
  }
  JavaUtilHashMap *moved = new_JavaUtilHashMap_init();
  for (AMDefferedListModification * __strong m in listModifications) {
    if ([((AMDefferedListModification *) nil_chk(m)) getOperation] == AMDefferedListModification_OperationEnum_get_MOVE()) {
      id element = [tempList getWithInt:[m getIndex]];
      if ([moved containsKeyWithId:element]) {
        [((AMDefferedListModification *) nil_chk([moved getWithId:element])) changeDestWithInt:[m getDestIndex]];
      }
      else {
        for (jint j = 0; j < [((JavaUtilArrayList *) nil_chk(initialList)) size]; j++) {
          if ([initialList getWithInt:j] == element) {
            AMDefferedListModification *mod = new_AMDefferedListModification_initWithAMDefferedListModification_OperationEnum_withInt_withInt_(AMDefferedListModification_OperationEnum_get_MOVE(), j, [m getDestIndex]);
            [optimizedModifications addWithId:mod];
          }
        }
      }
    }
  }
  return new_AMDefferedListChange_initWithJavaUtilArrayList_withJavaUtilArrayList_(initialList, optimizedModifications);
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(AMDefferedListChange)
