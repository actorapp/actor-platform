//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/actor-ios/build/java/im/actor/model/modules/updates/SequenceActor.java
//

#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "im/actor/model/api/DifferenceUpdate.h"
#include "im/actor/model/api/base/FatSeqUpdate.h"
#include "im/actor/model/api/base/SeqUpdate.h"
#include "im/actor/model/api/base/SeqUpdateTooLong.h"
#include "im/actor/model/api/base/WeakUpdate.h"
#include "im/actor/model/api/parser/UpdatesParser.h"
#include "im/actor/model/api/rpc/RequestGetDifference.h"
#include "im/actor/model/api/rpc/RequestGetState.h"
#include "im/actor/model/api/rpc/ResponseGetDifference.h"
#include "im/actor/model/api/rpc/ResponseSeq.h"
#include "im/actor/model/droidkit/actors/Actor.h"
#include "im/actor/model/droidkit/actors/ActorRef.h"
#include "im/actor/model/log/Log.h"
#include "im/actor/model/modules/Modules.h"
#include "im/actor/model/modules/updates/SequenceActor.h"
#include "im/actor/model/modules/updates/UpdateProcessor.h"
#include "im/actor/model/modules/updates/internal/InternalUpdate.h"
#include "im/actor/model/modules/utils/ModuleActor.h"
#include "im/actor/model/network/RpcException.h"
#include "im/actor/model/network/parser/Update.h"
#include "im/actor/model/storage/PreferencesStorage.h"
#include "java/io/IOException.h"
#include "java/lang/Integer.h"
#include "java/util/HashMap.h"
#include "java/util/List.h"

__attribute__((unused)) static void ImActorModelModulesUpdatesSequenceActor_onUpdateReceivedWithId_(ImActorModelModulesUpdatesSequenceActor *self, id u);
__attribute__((unused)) static jboolean ImActorModelModulesUpdatesSequenceActor_isValidSeqWithInt_(ImActorModelModulesUpdatesSequenceActor *self, jint seq);
__attribute__((unused)) static void ImActorModelModulesUpdatesSequenceActor_invalidate(ImActorModelModulesUpdatesSequenceActor *self);
__attribute__((unused)) static void ImActorModelModulesUpdatesSequenceActor_checkFuture(ImActorModelModulesUpdatesSequenceActor *self);

@interface ImActorModelModulesUpdatesSequenceActor () {
 @public
  JavaUtilHashMap *further_;
  jboolean isValidated_;
  jint seq_;
  IOSByteArray *state_;
  ImActorModelModulesUpdatesUpdateProcessor *processor_;
  ImActorModelApiParserUpdatesParser *parser_;
}

- (void)onUpdateReceivedWithId:(id)u;

- (jboolean)isValidSeqWithInt:(jint)seq;

- (void)invalidate;

- (void)checkFuture;
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesUpdatesSequenceActor, further_, JavaUtilHashMap *)
J2OBJC_FIELD_SETTER(ImActorModelModulesUpdatesSequenceActor, state_, IOSByteArray *)
J2OBJC_FIELD_SETTER(ImActorModelModulesUpdatesSequenceActor, processor_, ImActorModelModulesUpdatesUpdateProcessor *)
J2OBJC_FIELD_SETTER(ImActorModelModulesUpdatesSequenceActor, parser_, ImActorModelApiParserUpdatesParser *)

@interface ImActorModelModulesUpdatesSequenceActor_PushSeq () {
 @public
  jint seq_;
}
@end

@interface ImActorModelModulesUpdatesSequenceActor_$1 () {
 @public
  ImActorModelModulesUpdatesSequenceActor *this$0_;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesUpdatesSequenceActor_$1, this$0_, ImActorModelModulesUpdatesSequenceActor *)

@interface ImActorModelModulesUpdatesSequenceActor_$2 () {
 @public
  ImActorModelModulesUpdatesSequenceActor *this$0_;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesUpdatesSequenceActor_$2, this$0_, ImActorModelModulesUpdatesSequenceActor *)

@implementation ImActorModelModulesUpdatesSequenceActor

NSString * ImActorModelModulesUpdatesSequenceActor_TAG_ = @"Updates";
NSString * ImActorModelModulesUpdatesSequenceActor_KEY_SEQ_ = @"updates_seq";
NSString * ImActorModelModulesUpdatesSequenceActor_KEY_STATE_ = @"updates_state";

- (instancetype)initWithImActorModelModulesModules:(ImActorModelModulesModules *)modules {
  if (self = [super initWithImActorModelModulesModules:modules]) {
    further_ = [[JavaUtilHashMap alloc] init];
    isValidated_ = YES;
  }
  return self;
}

- (void)preStart {
  seq_ = [((id<ImActorModelStoragePreferencesStorage>) nil_chk([self preferences])) getIntWithNSString:ImActorModelModulesUpdatesSequenceActor_KEY_SEQ_ withInt:-1];
  state_ = [((id<ImActorModelStoragePreferencesStorage>) nil_chk([self preferences])) getBytesWithNSString:ImActorModelModulesUpdatesSequenceActor_KEY_STATE_];
  parser_ = [[ImActorModelApiParserUpdatesParser alloc] init];
  processor_ = [[ImActorModelModulesUpdatesUpdateProcessor alloc] initWithImActorModelModulesModules:[self modules]];
  [((ImActorModelDroidkitActorsActorRef *) nil_chk([self self__])) sendWithId:[[ImActorModelModulesUpdatesSequenceActor_Invalidate alloc] init]];
}

- (void)onReceiveWithId:(id)message {
  if ([message isKindOfClass:[ImActorModelModulesUpdatesSequenceActor_Invalidate class]] || [message isKindOfClass:[ImActorModelApiBaseSeqUpdateTooLong class]] || [message isKindOfClass:[ImActorModelModulesUpdatesSequenceActor_ForceInvalidate class]]) {
    ImActorModelModulesUpdatesSequenceActor_invalidate(self);
  }
  else if ([message isKindOfClass:[ImActorModelApiBaseSeqUpdate class]]) {
    ImActorModelModulesUpdatesSequenceActor_onUpdateReceivedWithId_(self, message);
  }
  else if ([message isKindOfClass:[ImActorModelApiBaseFatSeqUpdate class]]) {
    ImActorModelModulesUpdatesSequenceActor_onUpdateReceivedWithId_(self, message);
  }
  else if ([message isKindOfClass:[ImActorModelApiBaseWeakUpdate class]]) {
    ImActorModelModulesUpdatesSequenceActor_onUpdateReceivedWithId_(self, message);
  }
  else if ([message isKindOfClass:[ImActorModelModulesUpdatesInternalInternalUpdate class]]) {
    ImActorModelModulesUpdatesSequenceActor_onUpdateReceivedWithId_(self, message);
  }
}

- (void)onUpdateReceivedWithId:(id)u {
  ImActorModelModulesUpdatesSequenceActor_onUpdateReceivedWithId_(self, u);
}

- (jboolean)isValidSeqWithInt:(jint)seq {
  return ImActorModelModulesUpdatesSequenceActor_isValidSeqWithInt_(self, seq);
}

- (void)invalidate {
  ImActorModelModulesUpdatesSequenceActor_invalidate(self);
}

- (void)checkFuture {
  ImActorModelModulesUpdatesSequenceActor_checkFuture(self);
}

- (void)copyAllFieldsTo:(ImActorModelModulesUpdatesSequenceActor *)other {
  [super copyAllFieldsTo:other];
  other->further_ = further_;
  other->isValidated_ = isValidated_;
  other->seq_ = seq_;
  other->state_ = state_;
  other->processor_ = processor_;
  other->parser_ = parser_;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithImActorModelModulesModules:", "SequenceActor", NULL, 0x1, NULL },
    { "preStart", NULL, "V", 0x1, NULL },
    { "onReceiveWithId:", "onReceive", "V", 0x1, NULL },
    { "onUpdateReceivedWithId:", "onUpdateReceived", "V", 0x2, NULL },
    { "isValidSeqWithInt:", "isValidSeq", "Z", 0x2, NULL },
    { "invalidate", NULL, "V", 0x2, NULL },
    { "checkFuture", NULL, "V", 0x2, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "TAG_", NULL, 0x1a, "Ljava.lang.String;", &ImActorModelModulesUpdatesSequenceActor_TAG_,  },
    { "INVALIDATE_GAP_", NULL, 0x1a, "I", NULL, .constantValue.asInt = ImActorModelModulesUpdatesSequenceActor_INVALIDATE_GAP },
    { "KEY_SEQ_", NULL, 0x1a, "Ljava.lang.String;", &ImActorModelModulesUpdatesSequenceActor_KEY_SEQ_,  },
    { "KEY_STATE_", NULL, 0x1a, "Ljava.lang.String;", &ImActorModelModulesUpdatesSequenceActor_KEY_STATE_,  },
    { "further_", NULL, 0x2, "Ljava.util.HashMap;", NULL,  },
    { "isValidated_", NULL, 0x2, "Z", NULL,  },
    { "seq_", NULL, 0x2, "I", NULL,  },
    { "state_", NULL, 0x2, "[B", NULL,  },
    { "processor_", NULL, 0x2, "Lim.actor.model.modules.updates.UpdateProcessor;", NULL,  },
    { "parser_", NULL, 0x2, "Lim.actor.model.api.parser.UpdatesParser;", NULL,  },
  };
  static const J2ObjcClassInfo _ImActorModelModulesUpdatesSequenceActor = { 1, "SequenceActor", "im.actor.model.modules.updates", NULL, 0x1, 7, methods, 10, fields, 0, NULL};
  return &_ImActorModelModulesUpdatesSequenceActor;
}

@end

void ImActorModelModulesUpdatesSequenceActor_onUpdateReceivedWithId_(ImActorModelModulesUpdatesSequenceActor *self, id u) {
  jint seq;
  IOSByteArray *state;
  jint type;
  IOSByteArray *body;
  if ([u isKindOfClass:[ImActorModelApiBaseSeqUpdate class]]) {
    seq = [((ImActorModelApiBaseSeqUpdate *) nil_chk(((ImActorModelApiBaseSeqUpdate *) check_class_cast(u, [ImActorModelApiBaseSeqUpdate class])))) getSeq];
    state = [((ImActorModelApiBaseSeqUpdate *) nil_chk(((ImActorModelApiBaseSeqUpdate *) check_class_cast(u, [ImActorModelApiBaseSeqUpdate class])))) getState];
    type = [((ImActorModelApiBaseSeqUpdate *) nil_chk(((ImActorModelApiBaseSeqUpdate *) check_class_cast(u, [ImActorModelApiBaseSeqUpdate class])))) getUpdateHeader];
    body = [((ImActorModelApiBaseSeqUpdate *) nil_chk(((ImActorModelApiBaseSeqUpdate *) check_class_cast(u, [ImActorModelApiBaseSeqUpdate class])))) getUpdate];
  }
  else if ([u isKindOfClass:[ImActorModelApiBaseFatSeqUpdate class]]) {
    seq = [((ImActorModelApiBaseFatSeqUpdate *) nil_chk(((ImActorModelApiBaseFatSeqUpdate *) check_class_cast(u, [ImActorModelApiBaseFatSeqUpdate class])))) getSeq];
    state = [((ImActorModelApiBaseFatSeqUpdate *) nil_chk(((ImActorModelApiBaseFatSeqUpdate *) check_class_cast(u, [ImActorModelApiBaseFatSeqUpdate class])))) getState];
    type = [((ImActorModelApiBaseFatSeqUpdate *) nil_chk(((ImActorModelApiBaseFatSeqUpdate *) check_class_cast(u, [ImActorModelApiBaseFatSeqUpdate class])))) getUpdateHeader];
    body = [((ImActorModelApiBaseFatSeqUpdate *) nil_chk(((ImActorModelApiBaseFatSeqUpdate *) check_class_cast(u, [ImActorModelApiBaseFatSeqUpdate class])))) getUpdate];
  }
  else if ([u isKindOfClass:[ImActorModelApiBaseWeakUpdate class]]) {
    ImActorModelApiBaseWeakUpdate *w = (ImActorModelApiBaseWeakUpdate *) check_class_cast(u, [ImActorModelApiBaseWeakUpdate class]);
    AMLog_wWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_TAG_, @"Received weak update");
    @try {
      [((ImActorModelModulesUpdatesUpdateProcessor *) nil_chk(self->processor_)) processUpdateWithImActorModelNetworkParserUpdate:[((ImActorModelApiParserUpdatesParser *) nil_chk(self->parser_)) readWithInt:[((ImActorModelApiBaseWeakUpdate *) nil_chk(w)) getUpdateHeader] withByteArray:[w getUpdate]]];
    }
    @catch (JavaIoIOException *e) {
      [((JavaIoIOException *) nil_chk(e)) printStackTrace];
      AMLog_wWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_TAG_, @"Unable to parse update: ignoring");
    }
    return;
  }
  else if ([u isKindOfClass:[ImActorModelModulesUpdatesInternalInternalUpdate class]]) {
    AMLog_wWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_TAG_, @"Received internal update");
    [((ImActorModelModulesUpdatesUpdateProcessor *) nil_chk(self->processor_)) processInternalUpdateWithImActorModelModulesUpdatesInternalInternalUpdate:(ImActorModelModulesUpdatesInternalInternalUpdate *) check_class_cast(u, [ImActorModelModulesUpdatesInternalInternalUpdate class])];
    return;
  }
  else {
    return;
  }
  if (seq <= self->seq_) {
    AMLog_dWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_TAG_, JreStrcat("$IC", @"Ignored SeqUpdate {seq:", seq, '}'));
    return;
  }
  AMLog_dWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_TAG_, JreStrcat("$IC", @"SeqUpdate {seq:", seq, '}'));
  if (!self->isValidated_) {
    AMLog_dWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_TAG_, @"Caching in further map");
    (void) [((JavaUtilHashMap *) nil_chk(self->further_)) putWithId:JavaLangInteger_valueOfWithInt_(seq) withId:u];
    return;
  }
  if (!ImActorModelModulesUpdatesSequenceActor_isValidSeqWithInt_(self, seq)) {
    AMLog_wWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_TAG_, @"Out of sequence: starting timer for invalidation");
    (void) [((JavaUtilHashMap *) nil_chk(self->further_)) putWithId:JavaLangInteger_valueOfWithInt_(seq) withId:u];
    [((ImActorModelDroidkitActorsActorRef *) nil_chk([self self__])) sendOnceWithId:[[ImActorModelModulesUpdatesSequenceActor_ForceInvalidate alloc] init] withLong:ImActorModelModulesUpdatesSequenceActor_INVALIDATE_GAP];
    return;
  }
  ImActorModelNetworkParserUpdate *update;
  @try {
    update = [((ImActorModelApiParserUpdatesParser *) [[ImActorModelApiParserUpdatesParser alloc] init]) readWithInt:type withByteArray:body];
  }
  @catch (JavaIoIOException *e) {
    AMLog_wWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_TAG_, @"Unable to parse update: ignoring");
    [((JavaIoIOException *) nil_chk(e)) printStackTrace];
    return;
  }
  if ([((ImActorModelModulesUpdatesUpdateProcessor *) nil_chk(self->processor_)) isCausesInvalidationWithImActorModelNetworkParserUpdate:update]) {
    AMLog_wWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_TAG_, @"Message causes invalidation");
    ImActorModelModulesUpdatesSequenceActor_invalidate(self);
    return;
  }
  AMLog_dWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_TAG_, JreStrcat("$@", @"Processing update: ", update));
  if ([u isKindOfClass:[ImActorModelApiBaseFatSeqUpdate class]]) {
    ImActorModelApiBaseFatSeqUpdate *fatSeqUpdate = (ImActorModelApiBaseFatSeqUpdate *) check_class_cast(u, [ImActorModelApiBaseFatSeqUpdate class]);
    [self->processor_ applyRelatedWithJavaUtilList:[((ImActorModelApiBaseFatSeqUpdate *) nil_chk(fatSeqUpdate)) getUsers] withJavaUtilList:[fatSeqUpdate getGroups] withJavaUtilList:[fatSeqUpdate getContacts] withBoolean:NO];
  }
  [self->processor_ processUpdateWithImActorModelNetworkParserUpdate:update];
  if ([u isKindOfClass:[ImActorModelApiBaseFatSeqUpdate class]]) {
    ImActorModelApiBaseFatSeqUpdate *fatSeqUpdate = (ImActorModelApiBaseFatSeqUpdate *) check_class_cast(u, [ImActorModelApiBaseFatSeqUpdate class]);
    [self->processor_ applyRelatedWithJavaUtilList:[((ImActorModelApiBaseFatSeqUpdate *) nil_chk(fatSeqUpdate)) getUsers] withJavaUtilList:[fatSeqUpdate getGroups] withJavaUtilList:[fatSeqUpdate getContacts] withBoolean:YES];
  }
  self->seq_ = seq;
  self->state_ = state;
  [((id<ImActorModelStoragePreferencesStorage>) nil_chk([self preferences])) putIntWithNSString:ImActorModelModulesUpdatesSequenceActor_KEY_SEQ_ withInt:seq];
  [((id<ImActorModelStoragePreferencesStorage>) nil_chk([self preferences])) putBytesWithNSString:ImActorModelModulesUpdatesSequenceActor_KEY_STATE_ withByteArray:state];
  ImActorModelModulesUpdatesSequenceActor_checkFuture(self);
  [((ImActorModelDroidkitActorsActorRef *) nil_chk([self self__])) sendOnceWithId:[[ImActorModelModulesUpdatesSequenceActor_ForceInvalidate alloc] init] withLong:24 * 60 * 60 * 1000LL];
}

jboolean ImActorModelModulesUpdatesSequenceActor_isValidSeqWithInt_(ImActorModelModulesUpdatesSequenceActor *self, jint seq) {
  return self->seq_ <= 0 || seq == self->seq_ + 1;
}

void ImActorModelModulesUpdatesSequenceActor_invalidate(ImActorModelModulesUpdatesSequenceActor *self) {
  if (!self->isValidated_) {
    return;
  }
  self->isValidated_ = NO;
  if (self->seq_ < 0) {
    AMLog_dWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_TAG_, @"Loading fresh state...");
    [self requestWithImActorModelNetworkParserRequest:[[ImActorModelApiRpcRequestGetState alloc] init] withAMRpcCallback:[[ImActorModelModulesUpdatesSequenceActor_$1 alloc] initWithImActorModelModulesUpdatesSequenceActor:self]];
  }
  else {
    AMLog_dWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_TAG_, @"Loading difference...");
    [self requestWithImActorModelNetworkParserRequest:[[ImActorModelApiRpcRequestGetDifference alloc] initWithInt:self->seq_ withByteArray:self->state_] withAMRpcCallback:[[ImActorModelModulesUpdatesSequenceActor_$2 alloc] initWithImActorModelModulesUpdatesSequenceActor:self]];
  }
}

void ImActorModelModulesUpdatesSequenceActor_checkFuture(ImActorModelModulesUpdatesSequenceActor *self) {
  for (jint i = self->seq_ + 1; ; i++) {
    if ([((JavaUtilHashMap *) nil_chk(self->further_)) containsKeyWithId:JavaLangInteger_valueOfWithInt_(i)]) {
      [self onReceiveWithId:[self->further_ removeWithId:JavaLangInteger_valueOfWithInt_(i)]];
    }
    else {
      break;
    }
  }
  [((JavaUtilHashMap *) nil_chk(self->further_)) clear];
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesUpdatesSequenceActor)

@implementation ImActorModelModulesUpdatesSequenceActor_ForceInvalidate

- (instancetype)init {
  return [super init];
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "init", NULL, NULL, 0x1, NULL },
  };
  static const J2ObjcClassInfo _ImActorModelModulesUpdatesSequenceActor_ForceInvalidate = { 1, "ForceInvalidate", "im.actor.model.modules.updates", "SequenceActor", 0x9, 1, methods, 0, NULL, 0, NULL};
  return &_ImActorModelModulesUpdatesSequenceActor_ForceInvalidate;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesUpdatesSequenceActor_ForceInvalidate)

@implementation ImActorModelModulesUpdatesSequenceActor_Invalidate

- (instancetype)init {
  return [super init];
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "init", NULL, NULL, 0x1, NULL },
  };
  static const J2ObjcClassInfo _ImActorModelModulesUpdatesSequenceActor_Invalidate = { 1, "Invalidate", "im.actor.model.modules.updates", "SequenceActor", 0x9, 1, methods, 0, NULL, 0, NULL};
  return &_ImActorModelModulesUpdatesSequenceActor_Invalidate;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesUpdatesSequenceActor_Invalidate)

@implementation ImActorModelModulesUpdatesSequenceActor_PushSeq

- (instancetype)initWithInt:(jint)seq {
  if (self = [super init]) {
    self->seq_ = seq;
  }
  return self;
}

- (void)copyAllFieldsTo:(ImActorModelModulesUpdatesSequenceActor_PushSeq *)other {
  [super copyAllFieldsTo:other];
  other->seq_ = seq_;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithInt:", "PushSeq", NULL, 0x1, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "seq_", NULL, 0x2, "I", NULL,  },
  };
  static const J2ObjcClassInfo _ImActorModelModulesUpdatesSequenceActor_PushSeq = { 1, "PushSeq", "im.actor.model.modules.updates", "SequenceActor", 0x9, 1, methods, 1, fields, 0, NULL};
  return &_ImActorModelModulesUpdatesSequenceActor_PushSeq;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesUpdatesSequenceActor_PushSeq)

@implementation ImActorModelModulesUpdatesSequenceActor_$1

- (void)onResultWithImActorModelNetworkParserResponse:(ImActorModelApiRpcResponseSeq *)response {
  if (this$0_->isValidated_) {
    return;
  }
  this$0_->seq_ = [((ImActorModelApiRpcResponseSeq *) nil_chk(response)) getSeq];
  this$0_->state_ = [response getState];
  this$0_->isValidated_ = YES;
  [((id<ImActorModelStoragePreferencesStorage>) nil_chk([this$0_ preferences])) putIntWithNSString:ImActorModelModulesUpdatesSequenceActor_get_KEY_SEQ_() withInt:this$0_->seq_];
  [((id<ImActorModelStoragePreferencesStorage>) nil_chk([this$0_ preferences])) putBytesWithNSString:ImActorModelModulesUpdatesSequenceActor_get_KEY_STATE_() withByteArray:this$0_->state_];
  AMLog_dWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_get_TAG_(), JreStrcat("$IC", @"State loaded {seq=", this$0_->seq_, '}'));
  [((ImActorModelDroidkitActorsActorRef *) nil_chk([this$0_ self__])) sendOnceWithId:[[ImActorModelModulesUpdatesSequenceActor_ForceInvalidate alloc] init] withLong:24 * 60 * 60 * 1000LL];
  ImActorModelModulesUpdatesSequenceActor_checkFuture(this$0_);
}

- (void)onErrorWithAMRpcException:(AMRpcException *)e {
  if (this$0_->isValidated_) {
    return;
  }
  this$0_->isValidated_ = YES;
  ImActorModelModulesUpdatesSequenceActor_invalidate(this$0_);
}

- (instancetype)initWithImActorModelModulesUpdatesSequenceActor:(ImActorModelModulesUpdatesSequenceActor *)outer$ {
  this$0_ = outer$;
  return [super init];
}

- (void)copyAllFieldsTo:(ImActorModelModulesUpdatesSequenceActor_$1 *)other {
  [super copyAllFieldsTo:other];
  other->this$0_ = this$0_;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "onResultWithImActorModelApiRpcResponseSeq:", "onResult", "V", 0x1, NULL },
    { "onErrorWithAMRpcException:", "onError", "V", 0x1, NULL },
    { "initWithImActorModelModulesUpdatesSequenceActor:", "init", NULL, 0x0, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lim.actor.model.modules.updates.SequenceActor;", NULL,  },
  };
  static const J2ObjcClassInfo _ImActorModelModulesUpdatesSequenceActor_$1 = { 1, "$1", "im.actor.model.modules.updates", "SequenceActor", 0x8000, 3, methods, 1, fields, 0, NULL};
  return &_ImActorModelModulesUpdatesSequenceActor_$1;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesUpdatesSequenceActor_$1)

@implementation ImActorModelModulesUpdatesSequenceActor_$2

- (void)onResultWithImActorModelNetworkParserResponse:(ImActorModelApiRpcResponseGetDifference *)response {
  if (this$0_->isValidated_) {
    return;
  }
  AMLog_dWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_get_TAG_(), JreStrcat("$IC", @"Difference loaded {seq=", [((ImActorModelApiRpcResponseGetDifference *) nil_chk(response)) getSeq], '}'));
  [((ImActorModelModulesUpdatesUpdateProcessor *) nil_chk(this$0_->processor_)) applyRelatedWithJavaUtilList:[response getUsers] withJavaUtilList:[response getGroups] withJavaUtilList:[response getContacts] withBoolean:NO];
  for (ImActorModelApiDifferenceUpdate * __strong u in nil_chk([response getUpdates])) {
    @try {
      ImActorModelNetworkParserUpdate *update = [((ImActorModelApiParserUpdatesParser *) nil_chk(this$0_->parser_)) readWithInt:[((ImActorModelApiDifferenceUpdate *) nil_chk(u)) getUpdateHeader] withByteArray:[u getUpdate]];
      [this$0_->processor_ processUpdateWithImActorModelNetworkParserUpdate:update];
    }
    @catch (JavaIoIOException *e) {
      [((JavaIoIOException *) nil_chk(e)) printStackTrace];
      AMLog_dWithNSString_withNSString_(ImActorModelModulesUpdatesSequenceActor_get_TAG_(), JreStrcat("$I$", @"Broken update #", [((ImActorModelApiDifferenceUpdate *) nil_chk(u)) getUpdateHeader], @": ignoring"));
    }
  }
  [this$0_->processor_ applyRelatedWithJavaUtilList:[response getUsers] withJavaUtilList:[response getGroups] withJavaUtilList:[response getContacts] withBoolean:YES];
  this$0_->seq_ = [response getSeq];
  this$0_->state_ = [response getState];
  this$0_->isValidated_ = YES;
  [((id<ImActorModelStoragePreferencesStorage>) nil_chk([this$0_ preferences])) putIntWithNSString:ImActorModelModulesUpdatesSequenceActor_get_KEY_SEQ_() withInt:this$0_->seq_];
  [((id<ImActorModelStoragePreferencesStorage>) nil_chk([this$0_ preferences])) putBytesWithNSString:ImActorModelModulesUpdatesSequenceActor_get_KEY_STATE_() withByteArray:this$0_->state_];
  [((ImActorModelDroidkitActorsActorRef *) nil_chk([this$0_ self__])) sendOnceWithId:[[ImActorModelModulesUpdatesSequenceActor_ForceInvalidate alloc] init] withLong:24 * 60 * 60 * 1000LL];
  ImActorModelModulesUpdatesSequenceActor_checkFuture(this$0_);
  if ([response needMore]) {
    ImActorModelModulesUpdatesSequenceActor_invalidate(this$0_);
  }
}

- (void)onErrorWithAMRpcException:(AMRpcException *)e {
  if (this$0_->isValidated_) {
    return;
  }
  this$0_->isValidated_ = YES;
  ImActorModelModulesUpdatesSequenceActor_invalidate(this$0_);
}

- (instancetype)initWithImActorModelModulesUpdatesSequenceActor:(ImActorModelModulesUpdatesSequenceActor *)outer$ {
  this$0_ = outer$;
  return [super init];
}

- (void)copyAllFieldsTo:(ImActorModelModulesUpdatesSequenceActor_$2 *)other {
  [super copyAllFieldsTo:other];
  other->this$0_ = this$0_;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "onResultWithImActorModelApiRpcResponseGetDifference:", "onResult", "V", 0x1, NULL },
    { "onErrorWithAMRpcException:", "onError", "V", 0x1, NULL },
    { "initWithImActorModelModulesUpdatesSequenceActor:", "init", NULL, 0x0, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lim.actor.model.modules.updates.SequenceActor;", NULL,  },
  };
  static const J2ObjcClassInfo _ImActorModelModulesUpdatesSequenceActor_$2 = { 1, "$2", "im.actor.model.modules.updates", "SequenceActor", 0x8000, 3, methods, 1, fields, 0, NULL};
  return &_ImActorModelModulesUpdatesSequenceActor_$2;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesUpdatesSequenceActor_$2)
