//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/actor-ios/build/java/im/actor/model/jvm/threads/JavaDispatcherThreads.java
//

#include "IOSObjectArray.h"
#include "J2ObjC_source.h"
#include "im/actor/model/droidkit/actors/ActorTime.h"
#include "im/actor/model/droidkit/actors/ThreadPriority.h"
#include "im/actor/model/droidkit/actors/dispatch/AbstractDispatchQueue.h"
#include "im/actor/model/droidkit/actors/dispatch/Dispatch.h"
#include "im/actor/model/droidkit/actors/dispatch/DispatchResult.h"
#include "im/actor/model/jvm/threads/JavaDispatcherThreads.h"
#include "java/lang/InterruptedException.h"
#include "java/lang/Thread.h"
#include "java/lang/Throwable.h"
#include "java/util/concurrent/atomic/AtomicInteger.h"

@interface ImActorModelJvmThreadsJavaDispatcherThreads () {
 @public
  IOSObjectArray *threads_;
  jint count_;
  DKThreadPriorityEnum *priority_;
  jboolean isClosed_;
  jint id__;
  NSString *name_;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelJvmThreadsJavaDispatcherThreads, threads_, IOSObjectArray *)
J2OBJC_FIELD_SETTER(ImActorModelJvmThreadsJavaDispatcherThreads, priority_, DKThreadPriorityEnum *)
J2OBJC_FIELD_SETTER(ImActorModelJvmThreadsJavaDispatcherThreads, name_, NSString *)

@interface ImActorModelJvmThreadsJavaDispatcherThreads_DispatcherThread () {
 @public
  ImActorModelJvmThreadsJavaDispatcherThreads *this$0_;
  jboolean isChanged__;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelJvmThreadsJavaDispatcherThreads_DispatcherThread, this$0_, ImActorModelJvmThreadsJavaDispatcherThreads *)

BOOL ImActorModelJvmThreadsJavaDispatcherThreads_initialized = NO;

@implementation ImActorModelJvmThreadsJavaDispatcherThreads

JavaUtilConcurrentAtomicAtomicInteger * ImActorModelJvmThreadsJavaDispatcherThreads_INDEX_;

- (instancetype)initWithNSString:(NSString *)name
                         withInt:(jint)count
        withDKThreadPriorityEnum:(DKThreadPriorityEnum *)priority
     withDKAbstractDispatchQueue:(DKAbstractDispatchQueue *)queue
                  withDKDispatch:(id<DKDispatch>)dispatch
                     withBoolean:(jboolean)createThreads {
  if (self = [super initWithDKAbstractDispatchQueue:queue withDKDispatch:dispatch]) {
    isClosed_ = NO;
    self->id__ = [((JavaUtilConcurrentAtomicAtomicInteger *) nil_chk(ImActorModelJvmThreadsJavaDispatcherThreads_INDEX_)) getAndIncrement];
    self->name_ = name;
    self->count_ = count;
    self->priority_ = priority;
    if (createThreads) {
      [self startPool];
    }
  }
  return self;
}

- (void)startPool {
  if (self->threads_ != nil) {
    return;
  }
  self->threads_ = [IOSObjectArray newArrayWithLength:count_ type:JavaLangThread_class_()];
  for (jint i = 0; i < count_; i++) {
    IOSObjectArray_SetAndConsume(self->threads_, i, [[ImActorModelJvmThreadsJavaDispatcherThreads_DispatcherThread alloc] initWithImActorModelJvmThreadsJavaDispatcherThreads:self]);
    [((JavaLangThread *) nil_chk(IOSObjectArray_Get(self->threads_, i))) setNameWithNSString:JreStrcat("$$CI", @"Pool_", name_, '_', i)];
    switch ([priority_ ordinal]) {
      case DKThreadPriority_HIGH:
      [((JavaLangThread *) nil_chk(IOSObjectArray_Get(self->threads_, i))) setPriorityWithInt:JavaLangThread_MAX_PRIORITY];
      break;
      case DKThreadPriority_LOW:
      [((JavaLangThread *) nil_chk(IOSObjectArray_Get(self->threads_, i))) setPriorityWithInt:JavaLangThread_MIN_PRIORITY];
      break;
      default:
      case DKThreadPriority_NORMAL:
      [((JavaLangThread *) nil_chk(IOSObjectArray_Get(self->threads_, i))) setPriorityWithInt:JavaLangThread_NORM_PRIORITY];
      break;
    }
    [((JavaLangThread *) nil_chk(IOSObjectArray_Get(self->threads_, i))) start];
  }
}

- (void)close {
  isClosed_ = YES;
  [self notifyDispatcher];
}

- (void)notifyDispatcher {
  if (threads_ != nil) {
    @synchronized(threads_) {
      [threads_ notifyAll];
      {
        IOSObjectArray *a__ = threads_;
        JavaLangThread * const *b__ = a__->buffer_;
        JavaLangThread * const *e__ = b__ + a__->size_;
        while (b__ < e__) {
          JavaLangThread *thread = *b__++;
          [((ImActorModelJvmThreadsJavaDispatcherThreads_DispatcherThread *) nil_chk(((ImActorModelJvmThreadsJavaDispatcherThreads_DispatcherThread *) check_class_cast(thread, [ImActorModelJvmThreadsJavaDispatcherThreads_DispatcherThread class])))) setChangedWithBoolean:YES];
        }
      }
    }
  }
}

- (void)copyAllFieldsTo:(ImActorModelJvmThreadsJavaDispatcherThreads *)other {
  [super copyAllFieldsTo:other];
  other->threads_ = threads_;
  other->count_ = count_;
  other->priority_ = priority_;
  other->isClosed_ = isClosed_;
  other->id__ = id__;
  other->name_ = name_;
}

+ (void)initialize {
  if (self == [ImActorModelJvmThreadsJavaDispatcherThreads class]) {
    ImActorModelJvmThreadsJavaDispatcherThreads_INDEX_ = [[JavaUtilConcurrentAtomicAtomicInteger alloc] initWithInt:1];
    J2OBJC_SET_INITIALIZED(ImActorModelJvmThreadsJavaDispatcherThreads)
  }
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithNSString:withInt:withDKThreadPriorityEnum:withDKAbstractDispatchQueue:withDKDispatch:withBoolean:", "JavaDispatcherThreads", NULL, 0x1, NULL },
    { "startPool", NULL, "V", 0x1, NULL },
    { "close", NULL, "V", 0x1, NULL },
    { "notifyDispatcher", NULL, "V", 0x4, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "INDEX_", NULL, 0x1a, "Ljava.util.concurrent.atomic.AtomicInteger;", &ImActorModelJvmThreadsJavaDispatcherThreads_INDEX_,  },
    { "threads_", NULL, 0x2, "[Ljava.lang.Thread;", NULL,  },
    { "count_", NULL, 0x12, "I", NULL,  },
    { "priority_", NULL, 0x12, "Lim.actor.model.droidkit.actors.ThreadPriority;", NULL,  },
    { "isClosed_", NULL, 0x2, "Z", NULL,  },
    { "id__", "id", 0x12, "I", NULL,  },
    { "name_", NULL, 0x12, "Ljava.lang.String;", NULL,  },
  };
  static const char *superclass_type_args[] = {"TT;", "TQ;"};
  static const J2ObjcClassInfo _ImActorModelJvmThreadsJavaDispatcherThreads = { 1, "JavaDispatcherThreads", "im.actor.model.jvm.threads", NULL, 0x1, 4, methods, 7, fields, 2, superclass_type_args};
  return &_ImActorModelJvmThreadsJavaDispatcherThreads;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelJvmThreadsJavaDispatcherThreads)

@implementation ImActorModelJvmThreadsJavaDispatcherThreads_DispatcherThread

- (jboolean)isChanged {
  return isChanged__;
}

- (void)setChangedWithBoolean:(jboolean)isChanged {
  self->isChanged__ = isChanged;
}

- (void)run {
  while (!this$0_->isClosed_) {
    jlong time = DKActorTime_currentTime();
    @synchronized(this$0_->threads_) {
      isChanged__ = NO;
    }
    DKDispatchResult *action = [((DKAbstractDispatchQueue *) nil_chk([this$0_ getQueue])) dispatchWithLong:time];
    if (![((DKDispatchResult *) nil_chk(action)) isResult]) {
      if (isChanged__) {
        continue;
      }
      @synchronized(this$0_->threads_) {
        jlong delay = [action getDelay];
        [action recycle];
        @try {
          if (delay > 0) {
            [((IOSObjectArray *) nil_chk(this$0_->threads_)) waitWithLong:delay];
          }
          continue;
        }
        @catch (JavaLangInterruptedException *e) {
          [((JavaLangInterruptedException *) nil_chk(e)) printStackTrace];
          return;
        }
      }
    }
    @try {
      id actiondData = (id) [action getRes];
      [action recycle];
      [this$0_ dispatchMessageWithId:actiondData];
    }
    @catch (JavaLangThrowable *t) {
      [((JavaLangThrowable *) nil_chk(t)) printStackTrace];
    }
  }
}

- (instancetype)initWithImActorModelJvmThreadsJavaDispatcherThreads:(ImActorModelJvmThreadsJavaDispatcherThreads *)outer$ {
  this$0_ = outer$;
  if (self = [super init]) {
    isChanged__ = NO;
  }
  return self;
}

- (void)copyAllFieldsTo:(ImActorModelJvmThreadsJavaDispatcherThreads_DispatcherThread *)other {
  [super copyAllFieldsTo:other];
  other->this$0_ = this$0_;
  other->isChanged__ = isChanged__;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "isChanged", NULL, "Z", 0x1, NULL },
    { "setChangedWithBoolean:", "setChanged", "V", 0x1, NULL },
    { "run", NULL, "V", 0x1, NULL },
    { "initWithImActorModelJvmThreadsJavaDispatcherThreads:", "init", NULL, 0x0, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lim.actor.model.jvm.threads.JavaDispatcherThreads;", NULL,  },
    { "isChanged__", "isChanged", 0x2, "Z", NULL,  },
  };
  static const J2ObjcClassInfo _ImActorModelJvmThreadsJavaDispatcherThreads_DispatcherThread = { 1, "DispatcherThread", "im.actor.model.jvm.threads", "JavaDispatcherThreads", 0x2, 4, methods, 2, fields, 0, NULL};
  return &_ImActorModelJvmThreadsJavaDispatcherThreads_DispatcherThread;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelJvmThreadsJavaDispatcherThreads_DispatcherThread)
