//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-proprietary/actor-apps/core/src/main/java/im/actor/model/modules/messages/DialogsHistoryActor.java
//


#include "J2ObjC_source.h"
#include "im/actor/model/api/rpc/RequestLoadDialogs.h"
#include "im/actor/model/api/rpc/ResponseLoadDialogs.h"
#include "im/actor/model/droidkit/actors/Actor.h"
#include "im/actor/model/droidkit/actors/ActorRef.h"
#include "im/actor/model/droidkit/engine/PreferencesStorage.h"
#include "im/actor/model/log/Log.h"
#include "im/actor/model/modules/Modules.h"
#include "im/actor/model/modules/Updates.h"
#include "im/actor/model/modules/messages/DialogsHistoryActor.h"
#include "im/actor/model/modules/updates/internal/DialogHistoryLoaded.h"
#include "im/actor/model/modules/utils/ModuleActor.h"
#include "im/actor/model/network/RpcCallback.h"
#include "im/actor/model/network/RpcException.h"
#include "java/lang/Long.h"

#define ImActorModelModulesMessagesDialogsHistoryActor_LIMIT 20

@interface ImActorModelModulesMessagesDialogsHistoryActor () {
 @public
  jlong historyMaxDate_;
  jboolean historyLoaded_;
  jboolean isLoading_;
}

- (void)onLoadMore;

- (void)onLoadedMoreWithInt:(jint)loaded
                   withLong:(jlong)maxLoadedDate;

@end

static NSString *ImActorModelModulesMessagesDialogsHistoryActor_TAG_ = @"DialogsHistoryActor";
J2OBJC_STATIC_FIELD_GETTER(ImActorModelModulesMessagesDialogsHistoryActor, TAG_, NSString *)

J2OBJC_STATIC_FIELD_GETTER(ImActorModelModulesMessagesDialogsHistoryActor, LIMIT, jint)

static NSString *ImActorModelModulesMessagesDialogsHistoryActor_KEY_LOADED_DATE_ = @"dialogs_history_date";
J2OBJC_STATIC_FIELD_GETTER(ImActorModelModulesMessagesDialogsHistoryActor, KEY_LOADED_DATE_, NSString *)

static NSString *ImActorModelModulesMessagesDialogsHistoryActor_KEY_LOADED_ = @"dialogs_history_loaded";
J2OBJC_STATIC_FIELD_GETTER(ImActorModelModulesMessagesDialogsHistoryActor, KEY_LOADED_, NSString *)

static NSString *ImActorModelModulesMessagesDialogsHistoryActor_KEY_LOADED_INIT_ = @"dialogs_history_inited";
J2OBJC_STATIC_FIELD_GETTER(ImActorModelModulesMessagesDialogsHistoryActor, KEY_LOADED_INIT_, NSString *)

__attribute__((unused)) static void ImActorModelModulesMessagesDialogsHistoryActor_onLoadMore(ImActorModelModulesMessagesDialogsHistoryActor *self);

__attribute__((unused)) static void ImActorModelModulesMessagesDialogsHistoryActor_onLoadedMoreWithInt_withLong_(ImActorModelModulesMessagesDialogsHistoryActor *self, jint loaded, jlong maxLoadedDate);

@interface ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore () {
 @public
  jint loaded_;
  jlong maxLoadedDate_;
}

@end

@interface ImActorModelModulesMessagesDialogsHistoryActor_$1 : NSObject < AMRpcCallback > {
 @public
  ImActorModelModulesMessagesDialogsHistoryActor *this$0_;
}

- (void)onResult:(APResponseLoadDialogs *)response;

- (void)onError:(AMRpcException *)e;

- (instancetype)initWithImActorModelModulesMessagesDialogsHistoryActor:(ImActorModelModulesMessagesDialogsHistoryActor *)outer$;

@end

J2OBJC_EMPTY_STATIC_INIT(ImActorModelModulesMessagesDialogsHistoryActor_$1)

J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesDialogsHistoryActor_$1, this$0_, ImActorModelModulesMessagesDialogsHistoryActor *)

__attribute__((unused)) static void ImActorModelModulesMessagesDialogsHistoryActor_$1_initWithImActorModelModulesMessagesDialogsHistoryActor_(ImActorModelModulesMessagesDialogsHistoryActor_$1 *self, ImActorModelModulesMessagesDialogsHistoryActor *outer$);

__attribute__((unused)) static ImActorModelModulesMessagesDialogsHistoryActor_$1 *new_ImActorModelModulesMessagesDialogsHistoryActor_$1_initWithImActorModelModulesMessagesDialogsHistoryActor_(ImActorModelModulesMessagesDialogsHistoryActor *outer$) NS_RETURNS_RETAINED;

J2OBJC_TYPE_LITERAL_HEADER(ImActorModelModulesMessagesDialogsHistoryActor_$1)

@implementation ImActorModelModulesMessagesDialogsHistoryActor

- (instancetype)initWithImActorModelModulesModules:(ImActorModelModulesModules *)messenger {
  ImActorModelModulesMessagesDialogsHistoryActor_initWithImActorModelModulesModules_(self, messenger);
  return self;
}

- (void)preStart {
  historyMaxDate_ = [((id<DKPreferencesStorage>) nil_chk([self preferences])) getLongWithKey:ImActorModelModulesMessagesDialogsHistoryActor_KEY_LOADED_DATE_ withDefault:JavaLangLong_MAX_VALUE];
  historyLoaded_ = [((id<DKPreferencesStorage>) nil_chk([self preferences])) getBoolWithKey:ImActorModelModulesMessagesDialogsHistoryActor_KEY_LOADED_ withDefault:NO];
  if (![((id<DKPreferencesStorage>) nil_chk([self preferences])) getBoolWithKey:ImActorModelModulesMessagesDialogsHistoryActor_KEY_LOADED_INIT_ withDefault:NO]) {
    [((DKActorRef *) nil_chk([self self__])) sendOnceWithId:new_ImActorModelModulesMessagesDialogsHistoryActor_LoadMore_init()];
  }
}

- (void)onLoadMore {
  ImActorModelModulesMessagesDialogsHistoryActor_onLoadMore(self);
}

- (void)onLoadedMoreWithInt:(jint)loaded
                   withLong:(jlong)maxLoadedDate {
  ImActorModelModulesMessagesDialogsHistoryActor_onLoadedMoreWithInt_withLong_(self, loaded, maxLoadedDate);
}

- (void)onReceiveWithId:(id)message {
  if ([message isKindOfClass:[ImActorModelModulesMessagesDialogsHistoryActor_LoadMore class]]) {
    ImActorModelModulesMessagesDialogsHistoryActor_onLoadMore(self);
  }
  else if ([message isKindOfClass:[ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore class]]) {
    ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore *loaded = (ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore *) check_class_cast(message, [ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore class]);
    ImActorModelModulesMessagesDialogsHistoryActor_onLoadedMoreWithInt_withLong_(self, ((ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore *) nil_chk(loaded))->loaded_, loaded->maxLoadedDate_);
  }
  else {
    [self dropWithId:message];
  }
}

@end

void ImActorModelModulesMessagesDialogsHistoryActor_initWithImActorModelModulesModules_(ImActorModelModulesMessagesDialogsHistoryActor *self, ImActorModelModulesModules *messenger) {
  (void) ImActorModelModulesUtilsModuleActor_initWithImActorModelModulesModules_(self, messenger);
  self->isLoading_ = NO;
}

ImActorModelModulesMessagesDialogsHistoryActor *new_ImActorModelModulesMessagesDialogsHistoryActor_initWithImActorModelModulesModules_(ImActorModelModulesModules *messenger) {
  ImActorModelModulesMessagesDialogsHistoryActor *self = [ImActorModelModulesMessagesDialogsHistoryActor alloc];
  ImActorModelModulesMessagesDialogsHistoryActor_initWithImActorModelModulesModules_(self, messenger);
  return self;
}

void ImActorModelModulesMessagesDialogsHistoryActor_onLoadMore(ImActorModelModulesMessagesDialogsHistoryActor *self) {
  if (self->historyLoaded_) {
    return;
  }
  if (self->isLoading_) {
    return;
  }
  self->isLoading_ = YES;
  AMLog_dWithNSString_withNSString_(ImActorModelModulesMessagesDialogsHistoryActor_TAG_, JreStrcat("$J", @"Loading history... after ", self->historyMaxDate_));
  [self requestWithAPRequest:new_APRequestLoadDialogs_initWithLong_withInt_(self->historyMaxDate_, ImActorModelModulesMessagesDialogsHistoryActor_LIMIT) withAMRpcCallback:new_ImActorModelModulesMessagesDialogsHistoryActor_$1_initWithImActorModelModulesMessagesDialogsHistoryActor_(self)];
}

void ImActorModelModulesMessagesDialogsHistoryActor_onLoadedMoreWithInt_withLong_(ImActorModelModulesMessagesDialogsHistoryActor *self, jint loaded, jlong maxLoadedDate) {
  self->isLoading_ = NO;
  if (loaded < ImActorModelModulesMessagesDialogsHistoryActor_LIMIT) {
    self->historyLoaded_ = YES;
  }
  else {
    self->historyLoaded_ = NO;
    self->historyMaxDate_ = maxLoadedDate;
  }
  [((id<DKPreferencesStorage>) nil_chk([self preferences])) putLongWithKey:ImActorModelModulesMessagesDialogsHistoryActor_KEY_LOADED_DATE_ withValue:maxLoadedDate];
  [((id<DKPreferencesStorage>) nil_chk([self preferences])) putBoolWithKey:ImActorModelModulesMessagesDialogsHistoryActor_KEY_LOADED_ withValue:self->historyLoaded_];
  [((id<DKPreferencesStorage>) nil_chk([self preferences])) putBoolWithKey:ImActorModelModulesMessagesDialogsHistoryActor_KEY_LOADED_INIT_ withValue:YES];
  AMLog_dWithNSString_withNSString_(ImActorModelModulesMessagesDialogsHistoryActor_TAG_, JreStrcat("$J", @"History loaded, time = ", maxLoadedDate));
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesDialogsHistoryActor)

@implementation ImActorModelModulesMessagesDialogsHistoryActor_LoadMore

- (instancetype)init {
  ImActorModelModulesMessagesDialogsHistoryActor_LoadMore_init(self);
  return self;
}

@end

void ImActorModelModulesMessagesDialogsHistoryActor_LoadMore_init(ImActorModelModulesMessagesDialogsHistoryActor_LoadMore *self) {
  (void) NSObject_init(self);
}

ImActorModelModulesMessagesDialogsHistoryActor_LoadMore *new_ImActorModelModulesMessagesDialogsHistoryActor_LoadMore_init() {
  ImActorModelModulesMessagesDialogsHistoryActor_LoadMore *self = [ImActorModelModulesMessagesDialogsHistoryActor_LoadMore alloc];
  ImActorModelModulesMessagesDialogsHistoryActor_LoadMore_init(self);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesDialogsHistoryActor_LoadMore)

@implementation ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore

- (instancetype)initWithInt:(jint)loaded
                   withLong:(jlong)maxLoadedDate {
  ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore_initWithInt_withLong_(self, loaded, maxLoadedDate);
  return self;
}

@end

void ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore_initWithInt_withLong_(ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore *self, jint loaded, jlong maxLoadedDate) {
  (void) NSObject_init(self);
  self->loaded_ = loaded;
  self->maxLoadedDate_ = maxLoadedDate;
}

ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore *new_ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore_initWithInt_withLong_(jint loaded, jlong maxLoadedDate) {
  ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore *self = [ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore alloc];
  ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore_initWithInt_withLong_(self, loaded, maxLoadedDate);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesDialogsHistoryActor_LoadedMore)

@implementation ImActorModelModulesMessagesDialogsHistoryActor_$1

- (void)onResult:(APResponseLoadDialogs *)response {
  [((ImActorModelModulesUpdates *) nil_chk([this$0_ updates])) onUpdateReceivedWithId:new_ImActorModelModulesUpdatesInternalDialogHistoryLoaded_initWithAPResponseLoadDialogs_(response)];
}

- (void)onError:(AMRpcException *)e {
  [((AMRpcException *) nil_chk(e)) printStackTrace];
}

- (instancetype)initWithImActorModelModulesMessagesDialogsHistoryActor:(ImActorModelModulesMessagesDialogsHistoryActor *)outer$ {
  ImActorModelModulesMessagesDialogsHistoryActor_$1_initWithImActorModelModulesMessagesDialogsHistoryActor_(self, outer$);
  return self;
}

@end

void ImActorModelModulesMessagesDialogsHistoryActor_$1_initWithImActorModelModulesMessagesDialogsHistoryActor_(ImActorModelModulesMessagesDialogsHistoryActor_$1 *self, ImActorModelModulesMessagesDialogsHistoryActor *outer$) {
  self->this$0_ = outer$;
  (void) NSObject_init(self);
}

ImActorModelModulesMessagesDialogsHistoryActor_$1 *new_ImActorModelModulesMessagesDialogsHistoryActor_$1_initWithImActorModelModulesMessagesDialogsHistoryActor_(ImActorModelModulesMessagesDialogsHistoryActor *outer$) {
  ImActorModelModulesMessagesDialogsHistoryActor_$1 *self = [ImActorModelModulesMessagesDialogsHistoryActor_$1 alloc];
  ImActorModelModulesMessagesDialogsHistoryActor_$1_initWithImActorModelModulesMessagesDialogsHistoryActor_(self, outer$);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesDialogsHistoryActor_$1)
