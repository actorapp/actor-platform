//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/org/bouncycastle/crypto/generators/RSAKeyPairGenerator.java
//


#include "J2ObjC_source.h"
#include "im/actor/model/crypto/bouncycastle/RandomProvider.h"
#include "im/actor/model/log/Log.h"
#include "java/math/BigInteger.h"
#include "org/bouncycastle/crypto/AsymmetricCipherKeyPair.h"
#include "org/bouncycastle/crypto/KeyGenerationParameters.h"
#include "org/bouncycastle/crypto/generators/RSAKeyPairGenerator.h"
#include "org/bouncycastle/crypto/params/RSAKeyGenerationParameters.h"
#include "org/bouncycastle/crypto/params/RSAKeyParameters.h"
#include "org/bouncycastle/crypto/params/RSAPrivateCrtKeyParameters.h"
#include "org/bouncycastle/math/ec/WNafUtil.h"

@interface OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator () {
 @public
  OrgBouncycastleCryptoParamsRSAKeyGenerationParameters *param_;
}

@end

J2OBJC_FIELD_SETTER(OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator, param_, OrgBouncycastleCryptoParamsRSAKeyGenerationParameters *)

static JavaMathBigInteger *OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator_ONE_;
J2OBJC_STATIC_FIELD_GETTER(OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator, ONE_, JavaMathBigInteger *)

J2OBJC_INITIALIZED_DEFN(OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator)

@implementation OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator

- (void)init__WithOrgBouncycastleCryptoKeyGenerationParameters:(OrgBouncycastleCryptoKeyGenerationParameters *)param {
  self->param_ = (OrgBouncycastleCryptoParamsRSAKeyGenerationParameters *) check_class_cast(param, [OrgBouncycastleCryptoParamsRSAKeyGenerationParameters class]);
}

- (OrgBouncycastleCryptoAsymmetricCipherKeyPair *)generateKeyPair {
  JavaMathBigInteger *p, *q, *n, *d, *e, *pSub1, *qSub1, *phi;
  jint strength = [((OrgBouncycastleCryptoParamsRSAKeyGenerationParameters *) nil_chk(param_)) getStrength];
  jint qBitlength = URShift32(strength, 1);
  jint pBitlength = strength - qBitlength;
  jint mindiffbits = strength / 3;
  jint minWeight = URShift32(strength, 2);
  e = [param_ getPublicExponent];
  p = [self chooseRandomPrimeWithInt:pBitlength withJavaMathBigInteger:e];
  jint iteration = 0;
  for (; ; ) {
    iteration++;
    AMLog_dWithNSString_withNSString_(@"RSA", JreStrcat("$I", @"Iteration #", iteration));
    q = [self chooseRandomPrimeWithInt:qBitlength withJavaMathBigInteger:e];
    JavaMathBigInteger *diff = [((JavaMathBigInteger *) nil_chk([((JavaMathBigInteger *) nil_chk(q)) subtractWithJavaMathBigInteger:p])) abs];
    if ([((JavaMathBigInteger *) nil_chk(diff)) bitLength] < mindiffbits) {
      continue;
    }
    n = [((JavaMathBigInteger *) nil_chk(p)) multiplyWithJavaMathBigInteger:q];
    if ([((JavaMathBigInteger *) nil_chk(n)) bitLength] != strength) {
      p = [p maxWithJavaMathBigInteger:q];
      continue;
    }
    if (OrgBouncycastleMathEcWNafUtil_getNafWeightWithJavaMathBigInteger_(n) < minWeight) {
      p = [self chooseRandomPrimeWithInt:pBitlength withJavaMathBigInteger:e];
      continue;
    }
    break;
  }
  if ([((JavaMathBigInteger *) nil_chk(p)) compareToWithId:q] < 0) {
    phi = p;
    p = q;
    q = phi;
  }
  pSub1 = [((JavaMathBigInteger *) nil_chk(p)) subtractWithJavaMathBigInteger:OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator_ONE_];
  qSub1 = [((JavaMathBigInteger *) nil_chk(q)) subtractWithJavaMathBigInteger:OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator_ONE_];
  phi = [((JavaMathBigInteger *) nil_chk(pSub1)) multiplyWithJavaMathBigInteger:qSub1];
  d = [((JavaMathBigInteger *) nil_chk(e)) modInverseWithJavaMathBigInteger:phi];
  JavaMathBigInteger *dP, *dQ, *qInv;
  dP = [((JavaMathBigInteger *) nil_chk(d)) remainderWithJavaMathBigInteger:pSub1];
  dQ = [d remainderWithJavaMathBigInteger:qSub1];
  qInv = [q modInverseWithJavaMathBigInteger:p];
  return new_OrgBouncycastleCryptoAsymmetricCipherKeyPair_initWithOrgBouncycastleCryptoParamsAsymmetricKeyParameter_withOrgBouncycastleCryptoParamsAsymmetricKeyParameter_(new_OrgBouncycastleCryptoParamsRSAKeyParameters_initWithBoolean_withJavaMathBigInteger_withJavaMathBigInteger_(NO, n, e), new_OrgBouncycastleCryptoParamsRSAPrivateCrtKeyParameters_initWithJavaMathBigInteger_withJavaMathBigInteger_withJavaMathBigInteger_withJavaMathBigInteger_withJavaMathBigInteger_withJavaMathBigInteger_withJavaMathBigInteger_withJavaMathBigInteger_(n, e, d, p, q, dP, dQ, qInv));
}

- (JavaMathBigInteger *)chooseRandomPrimeWithInt:(jint)bitlength
                          withJavaMathBigInteger:(JavaMathBigInteger *)e {
  jint iteration = 0;
  for (; ; ) {
    iteration++;
    AMLog_dWithNSString_withNSString_(@"RSA", JreStrcat("$I", @"chooseRandomPrime #", iteration));
    JavaMathBigInteger *p = [((id<BCRandomProvider>) nil_chk([((OrgBouncycastleCryptoParamsRSAKeyGenerationParameters *) nil_chk(param_)) getRandom])) generateBigIntegerWithInt:bitlength withInt:1];
    if ([((JavaMathBigInteger *) nil_chk([((JavaMathBigInteger *) nil_chk(p)) modWithJavaMathBigInteger:e])) isEqual:OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator_ONE_]) {
      continue;
    }
    if (![p isProbablePrimeWithInt:[param_ getCertainty]]) {
      continue;
    }
    if (![((JavaMathBigInteger *) nil_chk([((JavaMathBigInteger *) nil_chk(e)) gcdWithJavaMathBigInteger:[p subtractWithJavaMathBigInteger:OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator_ONE_]])) isEqual:OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator_ONE_]) {
      continue;
    }
    return p;
  }
}

- (instancetype)init {
  OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator_init(self);
  return self;
}

+ (void)initialize {
  if (self == [OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator class]) {
    OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator_ONE_ = JavaMathBigInteger_valueOfWithLong_(1);
    J2OBJC_SET_INITIALIZED(OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator)
  }
}

@end

void OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator_init(OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator *self) {
  (void) NSObject_init(self);
}

OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator *new_OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator_init() {
  OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator *self = [OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator alloc];
  OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator_init(self);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgBouncycastleCryptoGeneratorsRSAKeyPairGenerator)
