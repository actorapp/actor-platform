//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-platform/actor-apps/library/core/src/main/java/im/actor/model/droidkit/actors/mailbox/collections/EnvelopeCollection.java
//


#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "J2ObjC_source.h"
#include "im/actor/model/droidkit/actors/Environment.h"
#include "im/actor/model/droidkit/actors/mailbox/Envelope.h"
#include "im/actor/model/droidkit/actors/mailbox/collections/EnvelopeCollection.h"
#include "im/actor/model/droidkit/actors/mailbox/collections/EnvelopeRoot.h"
#include "im/actor/model/droidkit/actors/mailbox/collections/ScheduledEnvelope.h"
#include "im/actor/model/util/AtomicIntegerCompat.h"
#include "im/actor/model/util/ThreadLocalCompat.h"
#include "java/lang/Long.h"
#include "java/util/Collection.h"
#include "java/util/Iterator.h"
#include "java/util/Map.h"
#include "java/util/Set.h"
#include "java/util/TreeMap.h"

@interface ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection () {
 @public
  JavaUtilTreeMap *envelopes_;
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *root_;
  jint id__;
  jlong topKey_;
}

@end

J2OBJC_FIELD_SETTER(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection, envelopes_, JavaUtilTreeMap *)
J2OBJC_FIELD_SETTER(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection, root_, ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *)

static AMAtomicIntegerCompat *ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_NEXT_ID_;
J2OBJC_STATIC_FIELD_GETTER(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection, NEXT_ID_, AMAtomicIntegerCompat *)

@interface ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult () {
 @public
  ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *envelope__;
  jlong delay__;
}

- (instancetype)initWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:(ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *)envelope;

- (instancetype)initWithLong:(jlong)delay;

@end

J2OBJC_FIELD_SETTER(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult, envelope__, ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *)

static AMThreadLocalCompat *ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_;
J2OBJC_STATIC_FIELD_GETTER(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult, RESULT_CACHE_, AMThreadLocalCompat *)
J2OBJC_STATIC_FIELD_SETTER(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult, RESULT_CACHE_, AMThreadLocalCompat *)

__attribute__((unused)) static void ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *self, ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *envelope);

__attribute__((unused)) static ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *new_ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *envelope) NS_RETURNS_RETAINED;

__attribute__((unused)) static void ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithLong_(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *self, jlong delay);

__attribute__((unused)) static ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *new_ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithLong_(jlong delay) NS_RETURNS_RETAINED;

J2OBJC_INITIALIZED_DEFN(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection)

@implementation ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection

- (instancetype)initWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot:(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *)root {
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_initWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot_(self, root);
  return self;
}

- (jint)getId {
  return id__;
}

- (jlong)getTopKey {
  return topKey_;
}

- (jlong)putEnvelopeWithDKEnvelope:(DKEnvelope *)envelope
                          withLong:(jlong)time {
  jlong key = [((ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *) nil_chk(root_)) buildKeyWithLong:time];
  jlong oldKey;
  @synchronized(envelopes_) {
    oldKey = topKey_;
    (void) [((JavaUtilTreeMap *) nil_chk(envelopes_)) putWithId:JavaLangLong_valueOfWithLong_(key) withId:new_ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_initWithLong_withLong_withDKEnvelope_(key, time, envelope)];
    if (key < topKey_ || topKey_ == 0) {
      topKey_ = key;
    }
  }
  if (oldKey != topKey_) {
    [root_ changedTopKeyWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection:self];
  }
  return key;
}

- (void)removeEnvelopeWithDKEnvelope:(DKEnvelope *)envelope
withImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator:(id<ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator>)comparator {
  jlong oldKey;
  @synchronized(envelopes_) {
    oldKey = topKey_;
    id<JavaUtilIterator> iterator = [((id<JavaUtilSet>) nil_chk([((JavaUtilTreeMap *) nil_chk(envelopes_)) entrySet])) iterator];
    while ([((id<JavaUtilIterator>) nil_chk(iterator)) hasNext]) {
      if ([((id<ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator>) nil_chk(comparator)) equalsWithDKEnvelope:[((ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *) nil_chk([((id<JavaUtilMap_Entry>) nil_chk([iterator next])) getValue])) getEnvelope] withDKEnvelope:envelope]) {
        [iterator remove];
      }
    }
    if ([envelopes_ isEmpty]) {
      topKey_ = 0;
    }
    else {
      topKey_ = [((JavaLangLong *) nil_chk([envelopes_ firstKey])) longLongValue];
    }
  }
  if (oldKey != topKey_) {
    [((ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *) nil_chk(root_)) changedTopKeyWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection:self];
  }
}

- (jlong)putEnvelopeOnceWithDKEnvelope:(DKEnvelope *)envelope
                              withLong:(jlong)time
withImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator:(id<ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator>)comparator {
  jlong key = [((ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *) nil_chk(root_)) buildKeyWithLong:time];
  jlong oldKey;
  @synchronized(envelopes_) {
    oldKey = topKey_;
    id<JavaUtilIterator> iterator = [((id<JavaUtilSet>) nil_chk([((JavaUtilTreeMap *) nil_chk(envelopes_)) entrySet])) iterator];
    while ([((id<JavaUtilIterator>) nil_chk(iterator)) hasNext]) {
      if ([((id<ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator>) nil_chk(comparator)) equalsWithDKEnvelope:[((ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *) nil_chk([((id<JavaUtilMap_Entry>) nil_chk([iterator next])) getValue])) getEnvelope] withDKEnvelope:envelope]) {
        [iterator remove];
      }
    }
    (void) [envelopes_ putWithId:JavaLangLong_valueOfWithLong_(key) withId:new_ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_initWithLong_withLong_withDKEnvelope_(key, time, envelope)];
    topKey_ = [((JavaLangLong *) nil_chk([envelopes_ firstKey])) longLongValue];
  }
  if (oldKey != topKey_) {
    [root_ changedTopKeyWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection:self];
  }
  return key;
}

- (ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *)fetchEnvelopeWithLong:(jlong)time {
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *result;
  jlong oldKey;
  @synchronized(envelopes_) {
    oldKey = topKey_;
    if ([((JavaUtilTreeMap *) nil_chk(envelopes_)) isEmpty]) {
      return nil;
    }
    ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *envelope = [((id<JavaUtilMap_Entry>) nil_chk([envelopes_ firstEntry])) getValue];
    if ([((ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *) nil_chk(envelope)) getTime] <= time) {
      (void) [envelopes_ removeWithId:JavaLangLong_valueOfWithLong_([envelope getKey])];
      if ([envelopes_ isEmpty]) {
        topKey_ = 0;
      }
      else {
        topKey_ = [((JavaLangLong *) nil_chk([envelopes_ firstKey])) longLongValue];
      }
      result = ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_envelopeWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(envelope);
    }
    else {
      result = ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_delayWithLong_([envelope getTime] - time);
    }
  }
  if (oldKey != topKey_) {
    [((ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *) nil_chk(root_)) changedTopKeyWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection:self];
  }
  return result;
}

- (void)clear {
  @synchronized(envelopes_) {
    [((JavaUtilTreeMap *) nil_chk(envelopes_)) clear];
    topKey_ = 0;
  }
  [((ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *) nil_chk(root_)) changedTopKeyWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection:self];
}

- (jint)getSize {
  @synchronized(envelopes_) {
    return [((JavaUtilTreeMap *) nil_chk(envelopes_)) size];
  }
}

- (IOSObjectArray *)allEnvelopes {
  @synchronized(envelopes_) {
    IOSObjectArray *scheduledEnvelopes = [((id<JavaUtilCollection>) nil_chk([((JavaUtilTreeMap *) nil_chk(envelopes_)) values])) toArrayWithNSObjectArray:[IOSObjectArray newArrayWithLength:[envelopes_ size] type:ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_class_()]];
    IOSObjectArray *res = [IOSObjectArray newArrayWithLength:((IOSObjectArray *) nil_chk(scheduledEnvelopes))->size_ type:DKEnvelope_class_()];
    for (jint i = 0; i < res->size_; i++) {
      (void) IOSObjectArray_Set(res, i, [((ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *) nil_chk(IOSObjectArray_Get(scheduledEnvelopes, i))) getEnvelope]);
    }
    return res;
  }
}

+ (void)initialize {
  if (self == [ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection class]) {
    ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_NEXT_ID_ = DKEnvironment_createAtomicIntWithInt_(1);
    J2OBJC_SET_INITIALIZED(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection)
  }
}

@end

void ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_initWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot_(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection *self, ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *root) {
  (void) NSObject_init(self);
  self->envelopes_ = new_JavaUtilTreeMap_init();
  self->id__ = [((AMAtomicIntegerCompat *) nil_chk(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_NEXT_ID_)) getAndIncrement];
  self->root_ = root;
  self->topKey_ = 0LL;
  [((ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *) nil_chk(self->root_)) attachCollectionWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection:self];
}

ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection *new_ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_initWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot_(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *root) {
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection *self = [ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection alloc];
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_initWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot_(self, root);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection)

J2OBJC_INTERFACE_TYPE_LITERAL_SOURCE(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator)

J2OBJC_INITIALIZED_DEFN(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult)

@implementation ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult

+ (ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *)envelopeWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:(ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *)envelope {
  return ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_envelopeWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(envelope);
}

+ (ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *)delayWithLong:(jlong)delay {
  return ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_delayWithLong_(delay);
}

- (instancetype)initWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:(ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *)envelope {
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(self, envelope);
  return self;
}

- (instancetype)initWithLong:(jlong)delay {
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithLong_(self, delay);
  return self;
}

- (ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *)getEnvelope {
  return envelope__;
}

- (jlong)getDelay {
  return delay__;
}

- (void)updateWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:(ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *)envelope
                                                                       withLong:(jlong)delay {
  self->envelope__ = envelope;
  self->delay__ = delay;
}

- (void)recycle {
  [((AMThreadLocalCompat *) nil_chk(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_)) setWithId:self];
}

+ (void)initialize {
  if (self == [ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult class]) {
    ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_ = DKEnvironment_createThreadLocal();
    J2OBJC_SET_INITIALIZED(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult)
  }
}

@end

ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_envelopeWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *envelope) {
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initialize();
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *res = [((AMThreadLocalCompat *) nil_chk(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_)) get];
  if (res != nil) {
    [ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_ remove];
    [res updateWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:envelope withLong:0];
  }
  else {
    res = new_ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(envelope);
  }
  return res;
}

ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_delayWithLong_(jlong delay) {
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initialize();
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *res = [((AMThreadLocalCompat *) nil_chk(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_)) get];
  if (res != nil) {
    [ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_ remove];
    [res updateWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:nil withLong:delay];
  }
  else {
    res = new_ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithLong_(delay);
  }
  return res;
}

void ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *self, ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *envelope) {
  (void) NSObject_init(self);
  self->envelope__ = envelope;
}

ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *new_ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *envelope) {
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *self = [ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult alloc];
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(self, envelope);
  return self;
}

void ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithLong_(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *self, jlong delay) {
  (void) NSObject_init(self);
  self->delay__ = delay;
}

ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *new_ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithLong_(jlong delay) {
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *self = [ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult alloc];
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initWithLong_(self, delay);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult)
